<script src="https://eqcn.ajz.miesnfu.com/wp-content/plugins/wp-3d-pony/live2dw/lib/L2Dwidget.min.js"></script> 
<script>
　　let models = [
    "https://unpkg.com/live2d-widget-model-chitose@1.0.5/assets/chitose.model.json",
    "https://unpkg.com/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json",
    "https://unpkg.com/live2d-widget-model-koharu@1.0.5/assets/koharu.model.json",
    "https://unpkg.com/live2d-widget-model-haruto@1.0.5/assets/haruto.model.json",
    "https://unpkg.com/live2d-widget-model-miku@1.0.5/assets/miku.model.json",
    "https://unpkg.com/live2d-widget-model-z16@1.0.5/assets/z16.model.json"
];
let m = models[Math.round(Math.random()*5)];
　　L2Dwidget.init({ 
　　"model": {jsonPath:m,"scale": 1 }, 
　　"display": { "position": "left", "width": 200, "height": 300,"hOffset": 0, "vOffset": -20 }, 
　　"mobile": { "show": true, "scale": 0.5 }, 
　　"react": { "opacityDefault": 0.7, "opacityOnHover": 0.2 } });
</script> 
<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="珲少的技术博客">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://huishao.cc">
    <meta name="referrer" content="no-referrer">
    <!--SEO-->

<meta name="description" content="珲少的技术博客">



<meta name="keywords" content="珲少">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">
    <!--Title-->


<title>让你的iOS应用程序支持运行JavaScript脚本：JavaScriptCore框架详解 | 珲少的技术博客</title>


    <link rel="alternate" href="/atom.xml" title="珲少的技术博客" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    





    
</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  style="background-image:url(http://7xpw2b.com1.z0.glb.clouddn.com/hexo-sinppet/img/banner.png)"  >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='珲少'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                <h2> 学如逆水行舟 </h2>
            
    	</div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://huishao.cc">珲少的技术博客</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>主页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/archives/"><i class="fa "></i>归档</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="让你的iOS应用程序支持运行JavaScript脚本：JavaScriptCore框架详解">
            
	            让你的iOS应用程序支持运行JavaScript脚本：JavaScriptCore框架详解
            
        </h1>
        <div class="post-meta">
    
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a href="/categories/iOS逻辑初窥">
            iOS逻辑初窥
        </a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
                
            
        </span>
    </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2017/03/10</span>
        </span>
    
</div>

            
            
    </div>
    
    <div class="post-body post-content">
        <h2 id="让你的iOS应用程序支持运行JavaScript脚本：JavaScriptCore框架详解"><a href="#让你的iOS应用程序支持运行JavaScript脚本：JavaScriptCore框架详解" class="headerlink" title="让你的iOS应用程序支持运行JavaScript脚本：JavaScriptCore框架详解"></a>让你的iOS应用程序支持运行JavaScript脚本：JavaScriptCore框架详解</h2><pre><code>说到JavaScript脚本，iOS开发者都会想到一个名叫JavaScriptCore的框架。这个框架的确十分强大，其中封装了一套JavaScript运行环境以及Native与JS数据类型之间的转换桥梁。本篇博客主要讨论如何使用此框架来在iOS应用中运行JavaScript脚本。
</code></pre><h3 id="一、JavaScriptCore框架结构"><a href="#一、JavaScriptCore框架结构" class="headerlink" title="一、JavaScriptCore框架结构"></a>一、JavaScriptCore框架结构</h3><pre><code>在学习一个框架时，首先应该先了解整个框架的结构，拿iOS开发来举例，对于一个陌生的框架，第一步需要先搞清楚这里面都包含哪些类，个各类之间是怎样的关系，这个框架和其他的框架间有无联系以及怎样产生的联系。将些问题搞清楚，有了大体上的认识后，我们再来学习其中的每个类即其他细节的应用将非常容易。我们先来看一张JavaScriptCore框架的结构图：
</code></pre><p><img src="https://static.oschina.net/uploads/space/2017/0309/153559_08eI_2340880.png" alt></p>
<p>这张图是我手工画的，不是那么美观并且没有文字的解释，但是我觉得它能非常直观的表达JavaScriptCore中包含的类之间的关系。下面我来向你解释这张图究竟表达了什么意思，首先原生的iOS应用是支持多线程执行任务的，我们知道JavaScript是单线程，但这并不代表我们不能在Native中异步执行不同的JavaScript代码。</p>
<p>1.JSVirtualMachine——JavaScript的虚拟机</p>
<pre><code>JavaScriptCore中提供了一个名为JSVirtualMachine的类，顾名思义，这个类可以理解为一个JS虚拟机。在Native中，只要你愿意，你可以创建任意多个JSVirtualMachine对象，各个JSViretualMachine对象间是相互独立的，他们之间不能共享数据也不能传递数据，如果你把他们放在不同的Native线程，他们就可以并行的执行无关的JS任务。
</code></pre><p>2.JSContext——JavaScript运行环境</p>
<pre><code>JSContext上下文对象可以理解为是JS的运行环境，同一个JSVirtualMachine对象可以关联多个JSContext对象，并且在WebView中每次刷新操作后，此WebView的JS运行环境都是不同的JSContext对象。其作用就是用来执行JS代码，在Native和JS间进行数据的传递。
</code></pre><p>3.JSValue——JavaScript值对象</p>
<pre><code>JavaScript和Objective-C虽然都是面向对象语言，但其实现机制完全不同，OC是基于类的，JS是基于原型的，并且他们的数据类型间也存在很大的差异。因此若要在Native和JS间无障碍的进行数据的传递，就需要一个中间对象做桥接，这个对象就是JSValue。
</code></pre><p>4.JSExport</p>
<pre><code>JSExport是一个协议，Native中遵守此解析的类可以将方法和属性转换为JS的接口供JS调用。
</code></pre><p>5.一些用于C语言的结构</p>
<pre><code>你一定注意到了，上图的右下角还有一块被虚线包围的区域，其中的&quot;类&quot;都是C语言风格，JavaScriptCore框架是支持在Objective-C、Swift和C三种语言中使用的。
</code></pre><h3 id="二、在Native中运行JavaScript脚本代码"><a href="#二、在Native中运行JavaScript脚本代码" class="headerlink" title="二、在Native中运行JavaScript脚本代码"></a>二、在Native中运行JavaScript脚本代码</h3><pre><code>我们先来编写一个最简单的例子，使用OC代码来执行一段JS脚本。首先新建一个文件，将其后缀设置为.js，我这里将它命令为main.js，在其中编写如下代码：
</code></pre><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Hello Native"</span>);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>上面是一个自执行的函数，其中打印了“Hello Native”字符串。在Native中编写如下代码：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="built_in">NSString</span> * path = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@"main"</span> ofType:<span class="string">@"js"</span>];</span><br><span class="line">    <span class="built_in">NSData</span> * jsData = [[<span class="built_in">NSData</span> alloc]initWithContentsOfFile:path];</span><br><span class="line">    <span class="built_in">NSString</span> * jsCode = [[<span class="built_in">NSString</span> alloc]initWithData:jsData encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="keyword">self</span>.jsContext = [[JSContext alloc]init];</span><br><span class="line">    [<span class="keyword">self</span>.jsContext evaluateScript:jsCode];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意，其实这里我将创建的JSContext对象作为了当前视图控制器的属性，这样做的目的仅仅是为了方便调试，不过不对此context对象进行引用，当viewDidLoad函数执行完成后，JS运行环境也将被销毁，我们就无法在Safari中直观的看到JS代码的执行结果了。</p>
<pre><code>运行工程，记得要打开Safari浏览器的自动显示JSContent检查器，如下图：
</code></pre><p><img src="https://static.oschina.net/uploads/space/2017/0309/161613_WsES_2340880.png" alt></p>
<p>当iOS模拟器跑起来后，Safari会自动弹出开发者工具，在控制台里面可以看到来自JavaScript的真挚问候：</p>
<p><img src="https://static.oschina.net/uploads/space/2017/0309/161801_rlwl_2340880.png" alt></p>
<p>刚才我们只是简单了通过原生调用了一段JS代码，但是如果Native在调JS方法时无法传参那也太low了，我们可以直接将要传递的参数格式化到字符串中，修改main.js文件如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">put</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Hello "</span>+name);</span><br><span class="line">&#125;;</span><br><span class="line">put(%@);</span><br></pre></td></tr></table></figure>
<p>再封装一个OC方法如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)runJS_Hello:(<span class="built_in">NSString</span> *)name&#123;</span><br><span class="line">    <span class="built_in">NSString</span> * path = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@"main"</span> ofType:<span class="string">@"js"</span>];</span><br><span class="line">    <span class="built_in">NSData</span> * jsData = [[<span class="built_in">NSData</span> alloc]initWithContentsOfFile:path];</span><br><span class="line">    <span class="built_in">NSString</span> * jsCode = [[<span class="built_in">NSString</span> alloc]initWithData:jsData encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="built_in">NSString</span> * finiString = [<span class="built_in">NSString</span> stringWithFormat:jsCode,name];</span><br><span class="line">    [<span class="keyword">self</span>.jsContext evaluateScript:finiString];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在viewDidLoad中进行调用，如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="keyword">self</span>.jsContext = [[JSContext alloc]init];</span><br><span class="line">    [<span class="keyword">self</span> runJS_Hello:<span class="string">@"'阿凡达'"</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行再看Safari控制台的结果，编程了Hello 阿凡达~：</p>
<p><img src="https://static.oschina.net/uploads/space/2017/0309/164019_ThKO_2340880.png" alt></p>
<p>其实evaluateScript函数执行后会将JS代码的执行结果进行返回，是JSValue类型的对象，后面会再介绍。</p>
<h3 id="三、在JavaScript中调用Native方法"><a href="#三、在JavaScript中调用Native方法" class="headerlink" title="三、在JavaScript中调用Native方法"></a>三、在JavaScript中调用Native方法</h3><pre><code>有来无往非君子，同样也可以在原生中编写方法让JS来调用，示例如下：
</code></pre><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="keyword">void</span>(^block)() = ^()&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Hello JavaScript"</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">self</span>.jsContext = [[JSContext alloc]init];</span><br><span class="line">    [<span class="keyword">self</span>.jsContext setObject:block forKeyedSubscript:<span class="string">@"oc_hello"</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面setObject:forKeyedSubscript:方法用来向JSContext环境的全局对象中添加属性，这里添加了一个函数属性，取名为oc_hello。这里JavaScriptCore会自动帮我们把一些数据类型进行转换，会将OC的函数转换为JS的函数，运行工程，在Safari的控制台中调用oc_hello函数，可以看到在Xcode控制台输出了对JavaScript的真挚问候，如下：</p>
<p><img src="https://static.oschina.net/uploads/space/2017/0309/165923_e6CG_2340880.png" alt></p>
<p>同样，如果声明的block是带参数的，JS在调用此OC方法时也需要传入参数，如果block有返回值，则在JS中也能获取到返回值，例如：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">BOOL</span> (^block)(<span class="built_in">NSString</span> *) = ^(<span class="built_in">NSString</span> *name)&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"Hello %@"</span>,name]);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">self</span>.jsContext = [[JSContext alloc]init];</span><br><span class="line">[<span class="keyword">self</span>.jsContext setObject:block forKeyedSubscript:<span class="string">@"oc_hello"</span>];</span><br></pre></td></tr></table></figure>
<h3 id="四、深入JSContext类"><a href="#四、深入JSContext类" class="headerlink" title="四、深入JSContext类"></a>四、深入JSContext类</h3><pre><code>看到这，你已经学会最基础的OC与JS互相问好(交互)。下面我们再来深入看下JSContext中的属性和方法。

创建JSContext对象有如下两种方式：
</code></pre><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建一个新的JS运行环境</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)init;</span><br><span class="line"><span class="comment">//创建一个新的JS运行环境 并关联到某个虚拟机对象上</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithVirtualMachine:(JSVirtualMachine *)virtualMachine;</span><br></pre></td></tr></table></figure>
<pre><code>执行JS代码有如下两个方法：
</code></pre><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//执行JS代码 结果将封装成JSValue对象返回</span></span><br><span class="line">- (JSValue *)evaluateScript:(<span class="built_in">NSString</span> *)script;</span><br><span class="line"><span class="comment">//作用同上</span></span><br><span class="line">- (JSValue *)evaluateScript:(<span class="built_in">NSString</span> *)script withSourceURL:(<span class="built_in">NSURL</span> *)sourceURL <span class="built_in">NS_AVAILABLE</span>(<span class="number">10</span>_10, <span class="number">8</span>_0);</span><br></pre></td></tr></table></figure>
<pre><code>下面的属性和方法可以获取到JS运行环境中的一些信息：
</code></pre><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//当前的JS运行环境 当JS调用OC方法时，在OC方法中可以用此方法获取到JS运行环境</span></span><br><span class="line">+ (JSContext *)currentContext;</span><br><span class="line"><span class="comment">//获取当前执行的JS函数，当JS调用OC方法时，在OC方法中可以用此方法获取到执行的函数</span></span><br><span class="line">+ (JSValue *)currentCallee;</span><br><span class="line"><span class="comment">//获取当前执行的JS函数中的this指向的对象</span></span><br><span class="line">+ (JSValue *)currentThis;</span><br><span class="line"><span class="comment">//获取当前执行函数的参数列表，当JS调用OC方法时，在OC方法中可以用此方法获取到执行的函数的参数列表</span></span><br><span class="line">+ (<span class="built_in">NSArray</span> *)currentArguments;</span><br><span class="line"><span class="comment">//获取当前JS运行环境的全局对象</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">strong</span>) JSValue *globalObject;</span><br><span class="line"><span class="comment">//当运行的JavaScript代码抛出了未捕获的异常时，这个属性会被赋值为抛出的异常</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>) JSValue *exception;</span><br><span class="line"><span class="comment">//设置为一个异常捕获的block，如果异常被此block捕获，exception属性就不再被赋值了</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span>) <span class="keyword">void</span>(^exceptionHandler)(JSContext *context, JSValue *exception);</span><br><span class="line"><span class="comment">//当前运行环境所关联的虚拟机</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">strong</span>) JSVirtualMachine *virtualMachine;</span><br><span class="line"><span class="comment">//当前运行环境名称</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="comment">//获取当前JS运行环境全局对象上的某个属性</span></span><br><span class="line">- (JSValue *)objectForKeyedSubscript:(<span class="keyword">id</span>)key;</span><br><span class="line"><span class="comment">//设置当前JS运行环境全局对象上的属性</span></span><br><span class="line">- (<span class="keyword">void</span>)setObject:(<span class="keyword">id</span>)object forKeyedSubscript:(<span class="built_in">NSObject</span> &lt;<span class="built_in">NSCopying</span>&gt; *)key;</span><br><span class="line"><span class="comment">//将C语言环境的JS运行环境转换为OC环境的JS运行环境</span></span><br><span class="line">+ (JSContext *)contextWithJSGlobalContextRef:(JSGlobalContextRef)jsGlobalContextRef;</span><br><span class="line"><span class="comment">//C语言环境的JS运行上下文</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) JSGlobalContextRef JSGlobalContextRef;</span><br></pre></td></tr></table></figure>
<h3 id="五、深入JSValue类"><a href="#五、深入JSValue类" class="headerlink" title="五、深入JSValue类"></a>五、深入JSValue类</h3><pre><code>JSValue是JavaScript与Objective-C之间的数据桥梁。在Objective-C中调用JS脚本或者JS调用OC方法都可以使用JSValue来传输数据。其中属性和方法示例如下：
</code></pre><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//所对应的JS运行环境</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">strong</span>) JSContext *context;</span><br><span class="line"><span class="comment">//在指定的JS运行环境中创建一个JSValue对象</span></span><br><span class="line">+ (JSValue *)valueWithObject:(<span class="keyword">id</span>)value inContext:(JSContext *)context;</span><br><span class="line"><span class="comment">//创建布尔值</span></span><br><span class="line">+ (JSValue *)valueWithBool:(<span class="built_in">BOOL</span>)value inContext:(JSContext *)context;</span><br><span class="line"><span class="comment">//创建浮点值</span></span><br><span class="line">+ (JSValue *)valueWithDouble:(<span class="keyword">double</span>)value inContext:(JSContext *)context;</span><br><span class="line"><span class="comment">//创建32位整型值</span></span><br><span class="line">+ (JSValue *)valueWithInt32:(int32_t)value inContext:(JSContext *)context;</span><br><span class="line"><span class="comment">//创建32位无符号整形值</span></span><br><span class="line">+ (JSValue *)valueWithUInt32:(uint32_t)value inContext:(JSContext *)context;</span><br><span class="line"><span class="comment">//创建空的JS对象</span></span><br><span class="line">+ (JSValue *)valueWithNewObjectInContext:(JSContext *)context;</span><br><span class="line"><span class="comment">//创建空的JS数组</span></span><br><span class="line">+ (JSValue *)valueWithNewArrayInContext:(JSContext *)context;</span><br><span class="line"><span class="comment">//创建JS正则对象</span></span><br><span class="line">+ (JSValue *)valueWithNewRegularExpressionFromPattern:(<span class="built_in">NSString</span> *)pattern flags:(<span class="built_in">NSString</span> *)flags inContext:(JSContext *)context;</span><br><span class="line"><span class="comment">//创建JS错误信息</span></span><br><span class="line">+ (JSValue *)valueWithNewErrorFromMessage:(<span class="built_in">NSString</span> *)message inContext:(JSContext *)context;</span><br><span class="line"><span class="comment">//创建JS null值</span></span><br><span class="line">+ (JSValue *)valueWithNullInContext:(JSContext *)context;</span><br><span class="line"><span class="comment">//创建JS undefined值</span></span><br><span class="line">+ (JSValue *)valueWithUndefinedInContext:(JSContext *)context;</span><br></pre></td></tr></table></figure>
<p>JavaScript中的数据类型和Objective-C的数据类型还是有着很大的差异，其中对应关系如下：</p>
<p>| Objective-C  | JavaScript |<br>| nil | undefined |<br>| NSNull | null |<br>| NSString | string |<br>| NSNumber | number boolean |<br>| NSDictionary    | Object |<br>| NSArray | Array |<br>| NSDate | Date    |<br>| Block | Function |<br>| id | Object |<br>| Class | Object |</p>
<p>下面这些方法可以将JSValue值转换为Objective-C中的数据类型：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将JSValue转换为OC对象</span></span><br><span class="line">- (<span class="keyword">id</span>)toObject;</span><br><span class="line"><span class="comment">//将JSValue转换成特定OC类的对象</span></span><br><span class="line">- (<span class="keyword">id</span>)toObjectOfClass:(Class)expectedClass;</span><br><span class="line"><span class="comment">//将JSValue转换成布尔值</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)toBool;</span><br><span class="line"><span class="comment">//将JSValue转换成浮点值</span></span><br><span class="line">- (<span class="keyword">double</span>)toDouble;</span><br><span class="line"><span class="comment">//将JSValue转换成32位整型值</span></span><br><span class="line">- (int32_t)toInt32;</span><br><span class="line"><span class="comment">//将JSValue转换成32位无符号整型值</span></span><br><span class="line">- (uint32_t)toUInt32;</span><br><span class="line"><span class="comment">//将JSValue转换成NSNumber值</span></span><br><span class="line">- (<span class="built_in">NSNumber</span> *)toNumber;</span><br><span class="line"><span class="comment">//将JSValue转换成NSString值</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)toString;</span><br><span class="line"><span class="comment">//将JSValue转换成NSDate值</span></span><br><span class="line">- (<span class="built_in">NSDate</span> *)toDate;</span><br><span class="line"><span class="comment">//将JSValue转换成NSArray值</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)toArray;</span><br><span class="line"><span class="comment">//将JSValue转换成NSDictionary值</span></span><br><span class="line">- (<span class="built_in">NSDictionary</span> *)toDictionary;</span><br><span class="line"><span class="comment">//获取JSValue对象中某个属性的值</span></span><br><span class="line">- (JSValue *)valueForProperty:(<span class="built_in">NSString</span> *)property;</span><br><span class="line"><span class="comment">//设置JSValue对象中某个属性的值</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">id</span>)value forProperty:(<span class="built_in">NSString</span> *)property;</span><br><span class="line"><span class="comment">//删除JSValue对象中的某个属性</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)deleteProperty:(<span class="built_in">NSString</span> *)property;</span><br><span class="line"><span class="comment">//判断JSValue对象中是否包含某个属性</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)hasProperty:(<span class="built_in">NSString</span> *)property;</span><br><span class="line"><span class="comment">//定义JSValue中的某个属性 这个方法和JavaScript中Object构造函数的defineProperty方法一致</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">第2个参数设置此属性的描述信息 可以设置的键值如下：</span></span><br><span class="line"><span class="comment">NSString * const JSPropertyDescriptorWritableKey;//设置布尔值 是否可写</span></span><br><span class="line"><span class="comment">NSString * const JSPropertyDescriptorEnumerableKey;//设置布尔值 是否可枚举</span></span><br><span class="line"><span class="comment">NSString * const JSPropertyDescriptorConfigurableKey;//设置布尔值 是否可配置</span></span><br><span class="line"><span class="comment">NSString * const JSPropertyDescriptorValueKey;//设置此属性的值</span></span><br><span class="line"><span class="comment">NSString * const JSPropertyDescriptorGetKey;//设置此属性的get方法</span></span><br><span class="line"><span class="comment">NSString * const JSPropertyDescriptorSetKey;//设置此属性的set方法</span></span><br><span class="line"><span class="comment">以上set、get方法的键和value、可写性的键不能同时存在，其语法是JavaScript保持一致</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)defineProperty:(<span class="built_in">NSString</span> *)property descriptor:(<span class="keyword">id</span>)descriptor;</span><br><span class="line"><span class="comment">//获取JS数组对象某个下标的值</span></span><br><span class="line">- (JSValue *)valueAtIndex:(<span class="built_in">NSUInteger</span>)index;</span><br><span class="line"><span class="comment">//设置JS数组对象某个下标的值</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">id</span>)value atIndex:(<span class="built_in">NSUInteger</span>)index;</span><br><span class="line"><span class="comment">//判断此对象是否为undefined</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">BOOL</span> isUndefined;</span><br><span class="line"><span class="comment">//判断此对象是否为null</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">BOOL</span> isNull;</span><br><span class="line"><span class="comment">//判断此对象是否为布尔值</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">BOOL</span> isBoolean;</span><br><span class="line"><span class="comment">//判断此对象是否为数值</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">BOOL</span> isNumber;</span><br><span class="line"><span class="comment">//判断此对象是否为字符串</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">BOOL</span> isString;</span><br><span class="line"><span class="comment">//判断此对象是否为object对象</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">BOOL</span> isObject;</span><br><span class="line"><span class="comment">//判断此对象是否为数组</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">BOOL</span> isArray;</span><br><span class="line"><span class="comment">//判断此对象是否为日期对象</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>) <span class="built_in">BOOL</span> isDate;</span><br><span class="line"><span class="comment">//比较两个JSValue是否全相等 对应JavaScript中的===</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)isEqualToObject:(<span class="keyword">id</span>)value;</span><br><span class="line"><span class="comment">//比较两个JSValue对象的值是否相等 对应JavaScript中的==</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)isEqualWithTypeCoercionToObject:(<span class="keyword">id</span>)value;</span><br><span class="line"><span class="comment">//判断某个对象是否在当前对象的原型链上</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)isInstanceOf:(<span class="keyword">id</span>)value;</span><br><span class="line"><span class="comment">//如果JSValue是Function对象 可以调用此方法 和JavaScript中的call方法一致</span></span><br><span class="line">- (JSValue *)callWithArguments:(<span class="built_in">NSArray</span> *)arguments;</span><br><span class="line"><span class="comment">//如果JSValue是一个构造方法对象 可以调用此方法 和JavaScript中使用new关键字一致</span></span><br><span class="line">- (JSValue *)constructWithArguments:(<span class="built_in">NSArray</span> *)arguments;</span><br><span class="line"><span class="comment">//用此对象进行函数的调用 当前对象会被绑定到this中</span></span><br><span class="line">- (JSValue *)invokeMethod:(<span class="built_in">NSString</span> *)method withArguments:(<span class="built_in">NSArray</span> *)arguments;</span><br><span class="line"><span class="comment">//将CGPoint转换为JSValue对象</span></span><br><span class="line">+ (JSValue *)valueWithPoint:(<span class="built_in">CGPoint</span>)point inContext:(JSContext *)context;</span><br><span class="line"><span class="comment">//将NSRange转换为JSValue对象</span></span><br><span class="line">+ (JSValue *)valueWithRange:(<span class="built_in">NSRange</span>)range inContext:(JSContext *)context;</span><br><span class="line"><span class="comment">//将CGRect转换为JSValue对象</span></span><br><span class="line">+ (JSValue *)valueWithRect:(<span class="built_in">CGRect</span>)rect inContext:(JSContext *)context;</span><br><span class="line"><span class="comment">//将CGSize转换为JSValue对象</span></span><br><span class="line">+ (JSValue *)valueWithSize:(<span class="built_in">CGSize</span>)size inContext:(JSContext *)context;</span><br><span class="line"><span class="comment">//转换成CGPoint数据</span></span><br><span class="line">- (<span class="built_in">CGPoint</span>)toPoint;</span><br><span class="line"><span class="comment">//转换成NSRange数据</span></span><br><span class="line">- (<span class="built_in">NSRange</span>)toRange;</span><br><span class="line"><span class="comment">//转换成CGRect数据</span></span><br><span class="line">- (<span class="built_in">CGRect</span>)toRect;</span><br><span class="line"><span class="comment">//转换为CGSize数据</span></span><br><span class="line">- (<span class="built_in">CGSize</span>)toSize;</span><br><span class="line"><span class="comment">//将C风格的JSValueRef对象转换为JSValue对象</span></span><br><span class="line">+ (JSValue *)valueWithJSValueRef:(JSValueRef)value inContext:(JSContext *)context;</span><br></pre></td></tr></table></figure>
<p>其实在JavaScriptCore框架中还有一个JSManagerValue类，这个的主要作用是管理内存。虽然我们在编写Objective-C代码时有强大的自动引用技术(ARC技术)，我们一般无需关心对象的内存问题，在编写JavaScript代码时也有强大的垃圾回收机制(这种机制下甚至连循环引用都不是问题)，但是在OC和JS混合开发时，就很容易出现问题了，比如一个JS垃圾回收机制释放掉的对象OC中却还在用，反过来也是一样。JSManagerValue对JSValue进行了一层包装，它可以保证在适合时候使用这个对象时对象都不会被释放，其中方法如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建JSVlaue对象的包装JSManagerValue</span></span><br><span class="line">+ (JSManagedValue *)managedValueWithValue:(JSValue *)value;</span><br><span class="line">+ (JSManagedValue *)managedValueWithValue:(JSValue *)value andOwner:(<span class="keyword">id</span>)owner;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithValue:(JSValue *)value;</span><br><span class="line"><span class="comment">//获取所包装的JSValue对象</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">strong</span>) JSValue *value;</span><br></pre></td></tr></table></figure>
<h3 id="六、Objective-C与JavaScript复杂对象的映射"><a href="#六、Objective-C与JavaScript复杂对象的映射" class="headerlink" title="六、Objective-C与JavaScript复杂对象的映射"></a>六、Objective-C与JavaScript复杂对象的映射</h3><pre><code>我们在使用JavaScript调用Objective-C方法的实质是将一个OC函数设置为了JS全局对象的一个属性，当然我们也可以设置非函数的属性或者任意JSValue(或者可以转换为JSValue)的值。例如：
</code></pre><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.jsContext = [[JSContext alloc]init];</span><br><span class="line"><span class="comment">//向JS全局对象中添加一个获取当前Native设备类型的属性</span></span><br><span class="line">[<span class="keyword">self</span>.jsContext setObject:<span class="string">@"iOS"</span> forKeyedSubscript:<span class="string">@"deviceType"</span>];</span><br></pre></td></tr></table></figure>
<p>但是如果我们想把OC自定义的一个类的对象设置为JS全局对象的某个属性，JS和OC有着完全不同的对象原理，如果不做任何处理，JS是接收不到OC对象中定义的属性和方法的。这时就需要使用到前面提到的JSExport协议，需要注意，这个协议不是用来被类遵守的，它里面没有规定任何方法，其是用来被继承定义新的协议的，自定义的协议中约定的方法和属性可以在JS中被获取到，示例如下:</p>
<p>OC中新建一个自定义的类：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">MyObjectProtocol</span> &lt;<span class="title">JSExport</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)<span class="built_in">NSString</span> * name;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)<span class="built_in">NSString</span> * subject;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>)<span class="built_in">NSInteger</span> age;</span><br><span class="line">-(<span class="keyword">void</span>)sayHi;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">MyObject</span> : <span class="title">NSObject</span>&lt;<span class="title">MyObjectProtocol</span>&gt;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)<span class="built_in">NSString</span> * name;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)<span class="built_in">NSString</span> * subject;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>)<span class="built_in">NSInteger</span> age;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MyObject</span></span></span><br><span class="line">-(<span class="keyword">void</span>)sayHi&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Hello JavaScript"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>添加到JS全局对象中：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MyObject* object = [MyObject new];</span><br><span class="line">object.name = <span class="string">@"Jaki"</span>;</span><br><span class="line">object.age = <span class="number">25</span>;</span><br><span class="line">object.subject = <span class="string">@"OC"</span>;</span><br><span class="line">[jsContext setObject:object forKeyedSubscript:<span class="string">@"deviceObject"</span>];</span><br></pre></td></tr></table></figure>
<p>在JS运行环境中可以完整的到deviceObject对象，如下：</p>
<p><img src="https://static.oschina.net/uploads/space/2017/0310/104404_GFB0_2340880.png" alt></p>
<h3 id="七、C语言风格的API解释"><a href="#七、C语言风格的API解释" class="headerlink" title="七、C语言风格的API解释"></a>七、C语言风格的API解释</h3><pre><code>JavaScriptCore框架中除了包含完整的Objective-C和Swift语言的API外，也提供了对C语言的支持。

与JS运行环境相关的方法如下：
</code></pre><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建一个JSContextRef组</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">JSContextRef相当于JSContext，同一组中的数据可以共享</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">JSContextGroupRef JSContextGroupCreate(<span class="keyword">void</span>);</span><br><span class="line"><span class="comment">//内存引用</span></span><br><span class="line">JSContextGroupRef JSContextGroupRetain(JSContextGroupRef group);</span><br><span class="line"><span class="comment">//内存引用释放</span></span><br><span class="line"><span class="keyword">void</span> JSContextGroupRelease(JSContextGroupRef group);</span><br><span class="line"><span class="comment">//创建一个全局的运行环境</span></span><br><span class="line">JSGlobalContextRef JSGlobalContextCreate(JSClassRef globalObjectClass);</span><br><span class="line"><span class="comment">//同上</span></span><br><span class="line">JSGlobalContextRef JSGlobalContextCreateInGroup(JSContextGroupRef group, JSClassRef globalObjectClass);</span><br><span class="line"><span class="comment">//内存引用</span></span><br><span class="line">JSGlobalContextRef JSGlobalContextRetain(JSGlobalContextRef ctx);</span><br><span class="line"><span class="comment">//内存引用释放</span></span><br><span class="line"><span class="keyword">void</span> JSGlobalContextRelease(JSGlobalContextRef ctx);</span><br><span class="line"><span class="comment">//获取全局对象</span></span><br><span class="line">JSObjectRef JSContextGetGlobalObject(JSContextRef ctx);</span><br><span class="line"><span class="comment">//获取JSContextRef组</span></span><br><span class="line">JSContextGroupRef JSContextGetGroup(JSContextRef ctx);</span><br><span class="line"><span class="comment">//获取全局的运行环境</span></span><br><span class="line">JSGlobalContextRef JSContextGetGlobalContext(JSContextRef ctx);</span><br><span class="line"><span class="comment">//获取运行环境名</span></span><br><span class="line">JSStringRef JSGlobalContextCopyName(JSGlobalContextRef ctx);</span><br><span class="line"><span class="comment">//设置运行环境名</span></span><br><span class="line"><span class="keyword">void</span> JSGlobalContextSetName(JSGlobalContextRef ctx, JSStringRef name);</span><br></pre></td></tr></table></figure>
<pre><code>与定义JS对象的相关方法如下：
</code></pre><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义JS类</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">参数JSClassDefinition是一个结构体 其中可以定义许多回调</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">JSClassRef JSClassCreate(<span class="keyword">const</span> JSClassDefinition* definition);</span><br><span class="line"><span class="comment">//引用内存</span></span><br><span class="line">JSClassRef JSClassRetain(JSClassRef jsClass);</span><br><span class="line"><span class="comment">//释放内存</span></span><br><span class="line"><span class="keyword">void</span> JSClassRelease(JSClassRef jsClass);</span><br><span class="line"><span class="comment">//创建一个JS对象</span></span><br><span class="line">JSObjectRef JSObjectMake(JSContextRef ctx, JSClassRef jsClass, <span class="keyword">void</span>* data);</span><br><span class="line"><span class="comment">//定义JS函数</span></span><br><span class="line">JSObjectRef JSObjectMakeFunctionWithCallback(JSContextRef ctx, JSStringRef name, JSObjectCallAsFunctionCallback callAsFunction);</span><br><span class="line"><span class="comment">//定义构造函数</span></span><br><span class="line">JSObjectRef JSObjectMakeConstructor(JSContextRef ctx, JSClassRef jsClass, JSObjectCallAsConstructorCallback callAsConstructor);</span><br><span class="line"><span class="comment">//定义数组</span></span><br><span class="line">JSObjectRef JSObjectMakeArray(JSContextRef ctx, size_t argumentCount, <span class="keyword">const</span> JSValueRef arguments[], JSValueRef* exception);</span><br><span class="line"><span class="comment">//定义日期对象</span></span><br><span class="line">JSObjectRef JSObjectMakeDate(JSContextRef ctx, size_t argumentCount, <span class="keyword">const</span> JSValueRef arguments[], JSValueRef* exception);</span><br><span class="line"><span class="comment">//定义异常对象</span></span><br><span class="line">JSObjectRef JSObjectMakeError(JSContextRef ctx, size_t argumentCount, <span class="keyword">const</span> JSValueRef arguments[], JSValueRef* exception);</span><br><span class="line"><span class="comment">//定义正则对象</span></span><br><span class="line">JSObjectRef JSObjectMakeRegExp(JSContextRef ctx, size_t argumentCount, <span class="keyword">const</span> JSValueRef arguments[], JSValueRef* exception);</span><br><span class="line"><span class="comment">//定义函数对象</span></span><br><span class="line">JSObjectRef JSObjectMakeFunction(JSContextRef ctx, JSStringRef name, <span class="keyword">unsigned</span> parameterCount, <span class="keyword">const</span> JSStringRef parameterNames[], JSStringRef body, JSStringRef sourceURL, <span class="keyword">int</span> startingLineNumber, JSValueRef* exception);</span><br><span class="line"><span class="comment">//获取对象的属性</span></span><br><span class="line">JSValueRef JSObjectGetPrototype(JSContextRef ctx, JSObjectRef object);</span><br><span class="line"><span class="comment">//设置对象的属性</span></span><br><span class="line"><span class="keyword">void</span> JSObjectSetPrototype(JSContextRef ctx, JSObjectRef object, JSValueRef value);</span><br><span class="line"><span class="comment">//检查对象是否包含某个属性</span></span><br><span class="line"><span class="keyword">bool</span> JSObjectHasProperty(JSContextRef ctx, JSObjectRef object, JSStringRef propertyName);</span><br><span class="line"><span class="comment">//获取对象属性</span></span><br><span class="line">JSValueRef JSObjectGetProperty(JSContextRef ctx, JSObjectRef object, JSStringRef propertyName, JSValueRef* exception);</span><br><span class="line"><span class="comment">//定义对象属性</span></span><br><span class="line"><span class="keyword">void</span> JSObjectSetProperty(JSContextRef ctx, JSObjectRef object, JSStringRef propertyName, JSValueRef value, JSPropertyAttributes attributes, JSValueRef* exception);</span><br><span class="line"><span class="comment">//删除对象属性</span></span><br><span class="line"><span class="keyword">bool</span> JSObjectDeleteProperty(JSContextRef ctx, JSObjectRef object, JSStringRef propertyName, JSValueRef* exception);</span><br><span class="line"><span class="comment">//获取数组值</span></span><br><span class="line">JSValueRef JSObjectGetPropertyAtIndex(JSContextRef ctx, JSObjectRef object, <span class="keyword">unsigned</span> propertyIndex, JSValueRef* exception);</span><br><span class="line"><span class="comment">//设置数组值</span></span><br><span class="line"><span class="keyword">void</span> JSObjectSetPropertyAtIndex(JSContextRef ctx, JSObjectRef object, <span class="keyword">unsigned</span> propertyIndex, JSValueRef value, JSValueRef* exception);</span><br><span class="line"><span class="comment">//获取私有数据</span></span><br><span class="line"><span class="keyword">void</span>* JSObjectGetPrivate(JSObjectRef object);</span><br><span class="line"><span class="comment">//设置私有数据</span></span><br><span class="line"><span class="keyword">bool</span> JSObjectSetPrivate(JSObjectRef object, <span class="keyword">void</span>* data);</span><br><span class="line"><span class="comment">//判断是否为函数</span></span><br><span class="line"><span class="keyword">bool</span> JSObjectIsFunction(JSContextRef ctx, JSObjectRef object);</span><br><span class="line"><span class="comment">//将对象作为函数来调用</span></span><br><span class="line">JSValueRef JSObjectCallAsFunction(JSContextRef ctx, JSObjectRef object, JSObjectRef thisObject, size_t argumentCount, <span class="keyword">const</span> JSValueRef arguments[], JSValueRef* exception);</span><br><span class="line"><span class="comment">//判断是否为构造函数</span></span><br><span class="line"><span class="keyword">bool</span> JSObjectIsConstructor(JSContextRef ctx, JSObjectRef object);</span><br><span class="line"><span class="comment">//将对象作为构造函数来调用</span></span><br><span class="line">JSObjectRef JSObjectCallAsConstructor(JSContextRef ctx, JSObjectRef object, size_t argumentCount, <span class="keyword">const</span> JSValueRef arguments[], JSValueRef* exception);</span><br><span class="line"><span class="comment">//获取所有属性名</span></span><br><span class="line">JSPropertyNameArrayRef JSObjectCopyPropertyNames(JSContextRef ctx, JSObjectRef object);</span><br><span class="line"><span class="comment">//进行内存引用</span></span><br><span class="line">JSPropertyNameArrayRef JSPropertyNameArrayRetain(JSPropertyNameArrayRef array);</span><br><span class="line"><span class="comment">//内存释放</span></span><br><span class="line"><span class="keyword">void</span> JSPropertyNameArrayRelease(JSPropertyNameArrayRef array);</span><br><span class="line"><span class="comment">//获取属性个数</span></span><br><span class="line">size_t JSPropertyNameArrayGetCount(JSPropertyNameArrayRef array);</span><br><span class="line"><span class="comment">//在属性名数组中取值</span></span><br><span class="line">JSStringRef JSPropertyNameArrayGetNameAtIndex(JSPropertyNameArrayRef array, size_t index);</span><br><span class="line"><span class="comment">//添加属性名</span></span><br><span class="line"><span class="keyword">void</span> JSPropertyNameAccumulatorAddName(JSPropertyNameAccumulatorRef accumulator, JSStringRef propertyName);</span><br></pre></td></tr></table></figure>
<pre><code>JS数据类型相关定义在JSValueRef中，如下：
</code></pre><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取值的类型</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">枚举如下：</span></span><br><span class="line"><span class="comment">typedef enum &#123;</span></span><br><span class="line"><span class="comment">    kJSTypeUndefined,</span></span><br><span class="line"><span class="comment">    kJSTypeNull,</span></span><br><span class="line"><span class="comment">    kJSTypeBoolean,</span></span><br><span class="line"><span class="comment">    kJSTypeNumber,</span></span><br><span class="line"><span class="comment">    kJSTypeString,</span></span><br><span class="line"><span class="comment">    kJSTypeObject</span></span><br><span class="line"><span class="comment">&#125; JSType;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">JSType JSValueGetType(JSContextRef ctx, JSValueRef);</span><br><span class="line"><span class="comment">//判断是否为undefined类型</span></span><br><span class="line"><span class="keyword">bool</span> JSValueIsUndefined(JSContextRef ctx, JSValueRef value);</span><br><span class="line"><span class="comment">//判断是否为null类型</span></span><br><span class="line"><span class="keyword">bool</span> JSValueIsNull(JSContextRef ctx, JSValueRef value);</span><br><span class="line"><span class="comment">//判断是否为布尔类型</span></span><br><span class="line"><span class="keyword">bool</span> JSValueIsBoolean(JSContextRef ctx, JSValueRef value);</span><br><span class="line"><span class="comment">//判断是否为数值类型</span></span><br><span class="line"><span class="keyword">bool</span> JSValueIsNumber(JSContextRef ctx, JSValueRef value);</span><br><span class="line"><span class="comment">//判断是否为字符串类型</span></span><br><span class="line"><span class="keyword">bool</span> JSValueIsString(JSContextRef ctx, JSValueRef value);</span><br><span class="line"><span class="comment">//判断是否为对象类型</span></span><br><span class="line"><span class="keyword">bool</span> JSValueIsObject(JSContextRef ctx, JSValueRef value);</span><br><span class="line"><span class="comment">//是否是类</span></span><br><span class="line"><span class="keyword">bool</span> JSValueIsObjectOfClass(JSContextRef ctx, JSValueRef value, JSClassRef jsClass);</span><br><span class="line"><span class="comment">//是否是数组</span></span><br><span class="line"><span class="keyword">bool</span> JSValueIsArray(JSContextRef ctx, JSValueRef value);</span><br><span class="line"><span class="comment">//是否是日期</span></span><br><span class="line"><span class="keyword">bool</span> JSValueIsDate(JSContextRef ctx, JSValueRef value);</span><br><span class="line"><span class="comment">//比较值是否相等</span></span><br><span class="line"><span class="keyword">bool</span> JSValueIsEqual(JSContextRef ctx, JSValueRef a, JSValueRef b, JSValueRef* exception);</span><br><span class="line"><span class="comment">//比较值是否全等</span></span><br><span class="line"><span class="keyword">bool</span> JSValueIsStrictEqual(JSContextRef ctx, JSValueRef a, JSValueRef b);</span><br><span class="line"><span class="comment">//是否是某个类的实例</span></span><br><span class="line"><span class="keyword">bool</span> JSValueIsInstanceOfConstructor(JSContextRef ctx, JSValueRef value, JSObjectRef constructor, JSValueRef* exception);</span><br><span class="line"><span class="comment">//创建undefined值</span></span><br><span class="line">JSValueRef JSValueMakeUndefined(JSContextRef ctx);</span><br><span class="line"><span class="comment">//创建null值</span></span><br><span class="line">JSValueRef JSValueMakeNull(JSContextRef ctx);</span><br><span class="line"><span class="comment">//创建布尔值</span></span><br><span class="line">JSValueRef JSValueMakeBoolean(JSContextRef ctx, <span class="keyword">bool</span> boolean);</span><br><span class="line"><span class="comment">//创建数值</span></span><br><span class="line">JSValueRef JSValueMakeNumber(JSContextRef ctx, <span class="keyword">double</span> number);</span><br><span class="line"><span class="comment">//创建字符串值</span></span><br><span class="line">JSValueRef JSValueMakeString(JSContextRef ctx, JSStringRef string);</span><br><span class="line"><span class="comment">//通过JSON创建对象</span></span><br><span class="line">JSValueRef JSValueMakeFromJSONString(JSContextRef ctx, JSStringRef string);</span><br><span class="line"><span class="comment">//将对象转为JSON字符串</span></span><br><span class="line">JSStringRef JSValueCreateJSONString(JSContextRef ctx, JSValueRef value, <span class="keyword">unsigned</span> indent, JSValueRef* exception);</span><br><span class="line"><span class="comment">//进行布尔值转换</span></span><br><span class="line"><span class="keyword">bool</span> JSValueToBoolean(JSContextRef ctx, JSValueRef value);</span><br><span class="line"><span class="comment">//进行数值转换</span></span><br><span class="line"><span class="keyword">double</span> JSValueToNumber(JSContextRef ctx, JSValueRef value, JSValueRef* exception);</span><br><span class="line"><span class="comment">//字符串值赋值</span></span><br><span class="line">JSStringRef JSValueToStringCopy(JSContextRef ctx, JSValueRef value, JSValueRef* exception);</span><br><span class="line"><span class="comment">//值与对象的转换</span></span><br><span class="line">JSObjectRef JSValueToObject(JSContextRef ctx, JSValueRef value, JSValueRef* exception);</span><br></pre></td></tr></table></figure>
<pre><code>在C风格的API中，字符串也被包装成了JSStringRef类型，其中方法如下：
</code></pre><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建js字符串</span></span><br><span class="line">JSStringRef JSStringCreateWithCharacters(<span class="keyword">const</span> JSChar* chars, size_t numChars);</span><br><span class="line">JSStringRef JSStringCreateWithUTF8CString(<span class="keyword">const</span> <span class="keyword">char</span>* string);</span><br><span class="line"><span class="comment">//内存引用于释放</span></span><br><span class="line">JSStringRef JSStringRetain(JSStringRef string);</span><br><span class="line"><span class="keyword">void</span> JSStringRelease(JSStringRef string);</span><br><span class="line"><span class="comment">//获取字符串长度</span></span><br><span class="line">size_t JSStringGetLength(JSStringRef string);</span><br><span class="line"><span class="comment">//转成UTF8字符串</span></span><br><span class="line">size_t JSStringGetUTF8CString(JSStringRef string, <span class="keyword">char</span>* buffer, size_t bufferSize);</span><br><span class="line"><span class="comment">//字符串比较</span></span><br><span class="line"><span class="keyword">bool</span> JSStringIsEqual(JSStringRef a, JSStringRef b);</span><br><span class="line"><span class="keyword">bool</span> JSStringIsEqualToUTF8CString(JSStringRef a, <span class="keyword">const</span> <span class="keyword">char</span>* b);</span><br></pre></td></tr></table></figure>
<h3 id="八、Hybird-App-构建思路"><a href="#八、Hybird-App-构建思路" class="headerlink" title="八、Hybird App 构建思路"></a>八、Hybird App 构建思路</h3><pre><code>Hybird App是指混合模式移动应用，即其中既包含原生的结构有内嵌有Web的组件。这种App不仅性能和用户体验可以达到和原生所差无几的程度，更大的优势在于bug修复快，版本迭代无需发版。3月8日苹果给许多开发者发送了一封警告邮件，主要是提示开发者下载脚本动态更改App原本行为的做法将会被提审拒绝。其实这次邮件所提内容和Hybird App并无太大关系(对ReactNative也没有影响)，苹果警告的是网络下发脚本并且使用runtime动态修改Native行为的应用，Hybird App的实质并没有修改原Native的行为，而是将下发的资源进行加载和界面渲染，类似WebView。

关于混合开发，我们有两种模式：

1.Native内嵌WebView，通过JS与OC交互实现业务无缝的衔接。

无论是UIWebView还是WKWebKit，我们都可以在其中拿到当前的JSContext，然是使用前面介绍的方法便可以实现数据互通与交互。这种方式是最简单的混合开发，但其性能和原生相比要差一些。示意图如下：
</code></pre><p><img src="https://static.oschina.net/uploads/space/2017/0310/133059_uOZl_2340880.png" alt></p>
<pre><code>2.下发JS脚本，使用类似ReactNative的框架进行原生渲染

这是一种效率非常高的混合开发模式，并且ReactNative也本身支持android和iOS公用一套代码。我们也可以使用JavaScriptCore自己实现一套解析逻辑，使用JavaScript来编写Native应用，要完整实现这样一套东西太复杂了，我们也没有能力完成一个如此庞大的工程，但是我们可以做一个小Demo来模拟其原理，这样可以更好的帮助我们理解Hybird App的构建原理。
</code></pre><p>我们打算实现这样的功能：通过下发JS脚本创建原生的UILabel标签与UIButton控件，首先编写JS代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"ProgectInit"</span>);</span><br><span class="line">    <span class="comment">//JS脚本加载完成后 自动render界面</span></span><br><span class="line">    <span class="keyword">return</span> render();</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">//JS标签类</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Label</span>(<span class="params">rect,text,color</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.rect = rect;</span><br><span class="line">    <span class="keyword">this</span>.text = text;</span><br><span class="line">    <span class="keyword">this</span>.color = color;</span><br><span class="line">    <span class="keyword">this</span>.typeName = <span class="string">"Label"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//JS按钮类</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Button</span>(<span class="params">rect,text,callFunc</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.rect = rect;</span><br><span class="line">    <span class="keyword">this</span>.text = text;</span><br><span class="line">    <span class="keyword">this</span>.callFunc = callFunc;</span><br><span class="line">    <span class="keyword">this</span>.typeName = <span class="string">"Button"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//JS Rect类</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Rect</span>(<span class="params">x,y,width,height</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.x = x;</span><br><span class="line">    <span class="keyword">this</span>.y = y;</span><br><span class="line">    <span class="keyword">this</span>.width = width;</span><br><span class="line">    <span class="keyword">this</span>.height = height;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//JS颜色类</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Color</span>(<span class="params">r,g,b,a</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.r = r;</span><br><span class="line">    <span class="keyword">this</span>.g = g;</span><br><span class="line">    <span class="keyword">this</span>.b = b;</span><br><span class="line">    <span class="keyword">this</span>.a = a;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">//渲染方法 界面的渲染写在这里面</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> rect = <span class="keyword">new</span> Rect(<span class="number">20</span>,<span class="number">100</span>,<span class="number">280</span>,<span class="number">30</span>);</span><br><span class="line">    <span class="keyword">var</span> color = <span class="keyword">new</span> Color(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">var</span> label = <span class="keyword">new</span> Label(rect,<span class="string">"Hello World"</span>,color);</span><br><span class="line">    <span class="keyword">var</span> rect2 = <span class="keyword">new</span> Rect(<span class="number">20</span>,<span class="number">150</span>,<span class="number">280</span>,<span class="number">30</span>);</span><br><span class="line">    <span class="keyword">var</span> color2 = <span class="keyword">new</span> Color(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">var</span> label2 = <span class="keyword">new</span> Label(rect2,<span class="string">"Hello Native"</span>,color2);</span><br><span class="line">    <span class="keyword">var</span> rect3 = <span class="keyword">new</span> Rect(<span class="number">20</span>,<span class="number">200</span>,<span class="number">280</span>,<span class="number">30</span>);</span><br><span class="line">    <span class="keyword">var</span> color3 = <span class="keyword">new</span> Color(<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">var</span> label3 = <span class="keyword">new</span> Label(rect3,<span class="string">"Hello JavaScript"</span>,color3);</span><br><span class="line">    <span class="keyword">var</span> rect4 = <span class="keyword">new</span> Rect(<span class="number">20</span>,<span class="number">240</span>,<span class="number">280</span>,<span class="number">30</span>);</span><br><span class="line">    <span class="keyword">var</span> button = <span class="keyword">new</span> Button(rect4,<span class="string">"我是一个按钮"</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                            <span class="keyword">var</span> randColor = <span class="keyword">new</span> Color(<span class="built_in">Math</span>.random(),<span class="built_in">Math</span>.random(),<span class="built_in">Math</span>.random(),<span class="number">1</span>);</span><br><span class="line">                            Globle.changeBackgroundColor(randColor);</span><br><span class="line">                            &#125;);</span><br><span class="line">    <span class="comment">//将控件以数组形式返回</span></span><br><span class="line">    <span class="keyword">return</span> [label,label2,label3,button];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>创建一个Objective-C类绑定到JS全局对象上，作为OC方法的桥接器：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//.h</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;JavaScriptCore/JavaScriptCore.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">GloblePrptocol</span> &lt;<span class="title">JSExport</span>&gt;</span></span><br><span class="line">-(<span class="keyword">void</span>)changeBackgroundColor:(JSValue *)value;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Globle</span> : <span class="title">NSObject</span>&lt;<span class="title">GloblePrptocol</span>&gt;</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">weak</span>)<span class="built_in">UIViewController</span> * ownerController;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="comment">//.m</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Globle.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Globle</span></span></span><br><span class="line">-(<span class="keyword">void</span>)changeBackgroundColor:(JSValue *)value&#123;</span><br><span class="line">    <span class="keyword">self</span>.ownerController.view.backgroundColor = [<span class="built_in">UIColor</span> colorWithRed:value[<span class="string">@"r"</span>].toDouble green:value[<span class="string">@"g"</span>].toDouble blue:value[<span class="string">@"b"</span>].toDouble alpha:value[<span class="string">@"a"</span>].toDouble];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>在ViewController中实现一个界面渲染的render解释方法，并建立按钮的方法转换，如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  ViewController.m</span></span><br><span class="line"><span class="comment">//  JavaScriptCoreTest</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by vip on 17/3/6.</span></span><br><span class="line"><span class="comment">//  Copyright © 2017年 jaki. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;JavaScriptCore/JavaScriptCore.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Globle.h"</span></span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)JSContext * jsContext;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)<span class="built_in">NSMutableArray</span> * actionArray;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)Globle * globle;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="comment">//创建JS运行环境</span></span><br><span class="line">    <span class="keyword">self</span>.jsContext = [JSContext new];</span><br><span class="line">    <span class="comment">//绑定桥接器</span></span><br><span class="line">    <span class="keyword">self</span>.globle =  [Globle new];</span><br><span class="line">    <span class="keyword">self</span>.globle.ownerController = <span class="keyword">self</span>;</span><br><span class="line">    <span class="keyword">self</span>.jsContext[<span class="string">@"Globle"</span>] = <span class="keyword">self</span>.globle;</span><br><span class="line">    <span class="keyword">self</span>.actionArray = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    [<span class="keyword">self</span> render];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//界面渲染解释器</span></span><br><span class="line">-(<span class="keyword">void</span>)render&#123;</span><br><span class="line">    <span class="built_in">NSString</span> * path = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@"main"</span> ofType:<span class="string">@"js"</span>];</span><br><span class="line">    <span class="built_in">NSData</span> * jsData = [[<span class="built_in">NSData</span> alloc]initWithContentsOfFile:path];</span><br><span class="line">    <span class="built_in">NSString</span> * jsCode = [[<span class="built_in">NSString</span> alloc]initWithData:jsData encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    JSValue * jsVlaue = [<span class="keyword">self</span>.jsContext evaluateScript:jsCode];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;jsVlaue.toArray.count; i++) &#123;</span><br><span class="line">        JSValue * subValue = [jsVlaue objectAtIndexedSubscript:i];</span><br><span class="line">        <span class="keyword">if</span> ([[subValue objectForKeyedSubscript:<span class="string">@"typeName"</span>].toString isEqualToString:<span class="string">@"Label"</span>]) &#123;</span><br><span class="line">            <span class="built_in">UILabel</span> * label = [<span class="built_in">UILabel</span> new];</span><br><span class="line">            label.frame = <span class="built_in">CGRectMake</span>(subValue[<span class="string">@"rect"</span>][<span class="string">@"x"</span>].toDouble, subValue[<span class="string">@"rect"</span>][<span class="string">@"y"</span>].toDouble, subValue[<span class="string">@"rect"</span>][<span class="string">@"width"</span>].toDouble, subValue[<span class="string">@"rect"</span>][<span class="string">@"height"</span>].toDouble);</span><br><span class="line">            label.text = subValue[<span class="string">@"text"</span>].toString;</span><br><span class="line">            label.textColor = [<span class="built_in">UIColor</span> colorWithRed:subValue[<span class="string">@"color"</span>][<span class="string">@"r"</span>].toDouble green:subValue[<span class="string">@"color"</span>][<span class="string">@"g"</span>].toDouble blue:subValue[<span class="string">@"color"</span>][<span class="string">@"b"</span>].toDouble alpha:subValue[<span class="string">@"color"</span>][<span class="string">@"a"</span>].toDouble];</span><br><span class="line">            [<span class="keyword">self</span>.view addSubview:label];</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> ([[subValue objectForKeyedSubscript:<span class="string">@"typeName"</span>].toString isEqualToString:<span class="string">@"Button"</span>])&#123;</span><br><span class="line">            <span class="built_in">UIButton</span> * button = [<span class="built_in">UIButton</span> buttonWithType:<span class="built_in">UIButtonTypeSystem</span>];</span><br><span class="line">            button.frame = <span class="built_in">CGRectMake</span>(subValue[<span class="string">@"rect"</span>][<span class="string">@"x"</span>].toDouble, subValue[<span class="string">@"rect"</span>][<span class="string">@"y"</span>].toDouble, subValue[<span class="string">@"rect"</span>][<span class="string">@"width"</span>].toDouble, subValue[<span class="string">@"rect"</span>][<span class="string">@"height"</span>].toDouble);</span><br><span class="line">            [button setTitle:subValue[<span class="string">@"text"</span>].toString forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">            button.tag = <span class="keyword">self</span>.actionArray.count;</span><br><span class="line">            [button addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(buttonAction:) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">            [<span class="keyword">self</span>.actionArray addObject:subValue[<span class="string">@"callFunc"</span>]];</span><br><span class="line">            [<span class="keyword">self</span>.view addSubview:button];</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//按钮转换方法</span></span><br><span class="line">-(<span class="keyword">void</span>)buttonAction:(<span class="built_in">UIButton</span> *)btn&#123;</span><br><span class="line">    JSValue * action  = <span class="keyword">self</span>.actionArray[btn.tag];</span><br><span class="line">    <span class="comment">//执行JS方法</span></span><br><span class="line">    [action callWithArguments:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>运行工程，效果如下图所示，点击按钮即可实现简单的界面颜色切换：</p>
<p><img src="https://static.oschina.net/uploads/space/2017/0310/150652_EQeM_2340880.png" alt></p>
<p>上面的示例工程我只实现了UILabel类与UIButton类的JS-OC转换，如果将原生控件和JS对象再进行一层绑定，并且实现大部分JS类与原生类和他们内部的属性，则我们就开发了一套Hybird App开发框架，但并没有这个必要，如果你对更多兴趣，可以深入学习下ReactNative。</p>
<pre><code>文中的示例Demo我放在了Github上，地址如下：[https://github.com/ZYHshao/Demo-Hybird](https://github.com/ZYHshao/Demo-Hybird)。
</code></pre><blockquote>
<p>前端学习新人，有志同道合的朋友，欢迎交流与指导，QQ群:541458536</p>
</blockquote>

    </div>

    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © 微信：15137348047
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/2017/03/13/317Git命令集十一——创建分支命令/" class="pre-post btn btn-default" title='Git命令集十一——创建分支命令'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">Git命令集十一——创建分支命令</span>
        </a>
    
    
        <a href="/2017/03/09/315Git命令集之十——文件移动命令/" class="next-post btn btn-default" title='Git命令集之十——文件移动命令'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">Git命令集之十——文件移动命令</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
<div id="lv-container" data-id="city" data-uid="MTAyMC8zNzY0Ny8xNDE3OA==">
  <script type="text/javascript">
     (function(d, s) {
         var j, e = d.getElementsByTagName(s)[0];
         if (typeof LivereTower === 'function') { return; }
         j = d.createElement(s);
         j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
         j.async = true;
         e.parentNode.insertBefore(j, e);
     })(document, 'script');
  </script>
</div>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#让你的iOS应用程序支持运行JavaScript脚本：JavaScriptCore框架详解"><span class="toc-text">让你的iOS应用程序支持运行JavaScript脚本：JavaScriptCore框架详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、JavaScriptCore框架结构"><span class="toc-text">一、JavaScriptCore框架结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、在Native中运行JavaScript脚本代码"><span class="toc-text">二、在Native中运行JavaScript脚本代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三、在JavaScript中调用Native方法"><span class="toc-text">三、在JavaScript中调用Native方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四、深入JSContext类"><span class="toc-text">四、深入JSContext类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#五、深入JSValue类"><span class="toc-text">五、深入JSValue类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#六、Objective-C与JavaScript复杂对象的映射"><span class="toc-text">六、Objective-C与JavaScript复杂对象的映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#七、C语言风格的API解释"><span class="toc-text">七、C语言风格的API解释</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#八、Hybird-App-构建思路"><span class="toc-text">八、Hybird App 构建思路</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12"> 
                <span>Copyright &copy; 2018
                </span> | 
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> | 
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>



<script src="/js/app.js?rev=@@hash"></script>


</body>
</html>