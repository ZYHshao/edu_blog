---
title: åœ¨iOSåº”ç”¨ä¸­ä½¿ç”¨å®æ—¶æ´»åŠ¨ä¸çµåŠ¨å²›
date: 2023-12-30
categories: iOSé€»è¾‘åˆçª¥
tags: []
---
# åœ¨iOSåº”ç”¨ä¸­ä½¿ç”¨å®æ—¶æ´»åŠ¨ä¸çµåŠ¨å²›

iOS16ç³»ç»Ÿå¼•å…¥äº†å®æ—¶æ´»åŠ¨ä¸çµåŠ¨å²›ç›¸å…³çš„APIã€‚å®æ—¶æ´»åŠ¨APIèƒ½å¤Ÿè®©ç”¨æˆ·åœ¨æ¡Œé¢ç›´æ¥æµè§ˆåˆ°åº”ç”¨ç¨‹åºæ‰€æä¾›çš„å®æ—¶æ€§è¾ƒé«˜çš„ä¿¡æ¯ï¼Œä¾‹å¦‚æ¯”èµ›çš„æ¯”åˆ†ä¿¡æ¯ï¼Œå¤–å–çš„é…é€è¿›åº¦ä¿¡æ¯ï¼Œç¥¨åŠ¡ä¿¡æ¯ç­‰ã€‚åœ¨æ”¯æŒçµåŠ¨å²›çš„è®¾å¤‡ä¸Šï¼Œå®æ—¶æ´»åŠ¨é…åˆçµåŠ¨å²›ï¼Œæ›´æ˜¯èƒ½å¸¦ç»™ç”¨æˆ·æ²‰æµ¸å¼çš„ä¿¡æ¯è·å–ä½“éªŒï¼Œåœ¨æŸäº›ç‰¹å®šåº”ç”¨åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨ã€‚

## 1 - å¼•è¨€

ä»iOS16å¼€å§‹ï¼Œå®æ—¶æ´»åŠ¨èƒ½å¤Ÿåœ¨é”å±ã€å¾…æœºæ¡Œé¢ä»¥åŠçµåŠ¨å²›ç­‰ä½ç½®æä¾›ä¿¡æ¯æ›´æ–°å±•ç¤ºã€‚åœ¨æŸäº›ç‰¹å®šåœºæ™¯ä¸‹ï¼Œå®æ—¶æ´»åŠ¨å¯ä»¥æä¾›ç»™ç”¨æˆ·å‡ ä¸ªå°æ—¶å†…æŒæ¡å®æ—¶äº‹ä»¶ã€æ´»åŠ¨æˆ–ä»»åŠ¡æ›´æ–°ã€‚å¸¸è§çš„åº”ç”¨åœºæ™¯æœ‰ï¼š

\- å¤–å–ç±»åº”ç”¨å®æ—¶æä¾›ç”¨æˆ·é…é€è¿›åº¦ï¼Œå‰©ä½™æ—¶é—´ã€‚

\- èµ›äº‹ç±»åº”ç”¨çš„å®æ—¶åˆ†æ•°ã€‚

\- å¥èº«ç±»åº”ç”¨ä¸å¯ç©¿æˆ´è®¾å¤‡çš„å®æ—¶ä½“èƒ½çŠ¶æ€æ›´æ–°ã€‚

å®æ—¶åº”ç”¨å°†ä¼šå±•ç¤ºåœ¨è®¾å¤‡çš„ï¼š

\- é”å±é¡µé¢

\- é€šçŸ¥åˆ—è¡¨é¡¶éƒ¨

\- åœ¨æ”¯æŒçµåŠ¨å²›çš„è®¾å¤‡ä¸Šï¼Œåœ¨çµåŠ¨å²›ä½ç½®å±•ç¤º

\- ä¸æ”¯æŒçµåŠ¨å²›çš„è®¾å¤‡ä¸Šï¼Œå®æ—¶æ´»åŠ¨çš„æ›´æ–°ä¼šåœ¨å±å¹•é¡¶éƒ¨å¼¹å‡ºé€šçŸ¥

\- å¾…æœºæ˜¾ç¤ºæ—¶ï¼Œå®æ—¶æ´»åŠ¨ä¼šå……æ»¡æ•´ä¸ªå±å¹•

éœ€è¦æ³¨æ„ï¼ŒçµåŠ¨å²›çš„å¯å¯æ˜¾ç¤ºåŒºåŸŸä¼˜å…ˆï¼Œåœ¨å¼€å‘å®æ—¶æ´»åŠ¨æ—¶ï¼Œåœ¨è®¾è®¡ä¸Šå¯ä»¥å‚è€ƒä¸‹é¢çš„æœ€ä½³å®è·µæ–‡æ¡£ï¼š

[https://developer.apple.com/cn/design/human-interface-guidelines/live-activities/](https://developer.apple.com/cn/design/human-interface-guidelines/live-activities/)

## 2 - å¼€å‘å®æ—¶æ´»åŠ¨ä¸é€‚é…çµåŠ¨å²›

é¦–å…ˆï¼Œè¦æ”¯æŒå®æ—¶æ´»åŠ¨éœ€è¦åœ¨å·¥ç¨‹ä¸­åˆ›å»ºä¸€ä¸ªWidget Extensionï¼Œå®æ—¶æ´»åŠ¨æœ¬èº«ä¹Ÿæ˜¯å°ç»„ä»¶çš„ä¸€ç§ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://oscimg.oschina.net/oscnet/up-37c2b760860571f79e65c852e883c6934e4.png)

éœ€è¦æ³¨æ„ï¼Œåœ¨åˆ›å»ºWidgetå°ç»„ä»¶æ—¶ï¼Œå°†Include Live Activicyé€‰ä¸­ï¼Œå¦‚ä¸‹å›¾ï¼š

![](https://oscimg.oschina.net/oscnet/up-0ce2a07fb26403a6f07e1f63431cedf9c24.png)

è™½ç„¶å®æ—¶æ´»åŠ¨ä¹Ÿæ˜¯å°ç»„ä»¶ï¼Œä½†å…¶ä»–æ™®é€šçš„WidgetåŒºåˆ«å¾ˆå¤§ï¼Œå°ç»„ä»¶æ˜¯é€šè¿‡Timelineæ¥è¿›è¡Œæ›´æ–°ï¼Œè€Œå®æ—¶æ´»åŠ¨åªèƒ½é€šè¿‡Appè§¦å‘æ›´æ–°æˆ–ç‰¹æ®ŠPushæ›´æ–°å’Œå…³é—­ï¼›å°ç»„ä»¶éœ€è¦ç”¨æˆ·æ‰‹åŠ¨æ·»åŠ ä½¿ç”¨ï¼Œè€Œå®æ—¶æ´»åŠ¨åˆ™æ˜¯ç”±ä¸»Appè¿›è¡Œå¼€å¯ã€‚åˆ›å»ºå¥½Tatgetåï¼Œæ¨¡ç‰ˆè‡ªå¸¦3ä¸ªæ–‡ä»¶ï¼Œå…¶ä¸­LiveWidgetLiveActivityä¸­å®æ—¶æ´»åŠ¨çš„æ ¸å¿ƒæ¡†æ¶ä»£ç ï¼Œæˆ‘ä»¬åšäº›ç®€å•çš„ä¿®æ”¹ï¼Œå¦‚ä¸‹ï¼š

```swift
import ActivityKit
import WidgetKit
import SwiftUI
// çŠ¶æ€ç»“æ„ä½“
struct LiveWidgetAttributes: ActivityAttributes {
    public struct ContentState: Codable, Hashable {
        // åŠ¨æ€çš„çŠ¶æ€ï¼Œæœ‰Appæˆ–Pushæ¥è§¦å‘æ›´æ–°
        var score: String
    }

    // é™æ€çš„çŠ¶æ€ï¼Œå®æ—¶æ´»åŠ¨å¼€å¯æ—¶æŒ‡å®š
    var name: String
    var teamA: String
    var teamB: String
}

// ç¼–å†™SwiftUIé¡µé¢
struct LiveWidgetLiveActivity: Widget {
    var body: some WidgetConfiguration {
        ActivityConfiguration(for: LiveWidgetAttributes.self) { context in
            // Lock screen/banner UI goes here
            VStack {
                Text(context.attributes.name)
                Text("ğŸ’»ğŸ’»ğŸ’»ğŸ’»ğŸ’»ğŸ’»ğŸ’»ğŸ’»ğŸ’»ğŸ’»ğŸ’»")
                Text("\(context.attributes.teamA) å¯¹æˆ˜ \(context.attributes.teamB)")
                Text("å½“å‰æ¯”åˆ†:\(context.state.score)")
            }.padding(.all, 10)
            .activityBackgroundTint(Color.cyan)
            .activitySystemActionForegroundColor(Color.black)

        } dynamicIsland: { context in
            DynamicIsland {
                // Expanded UI goes here.  Compose the expanded UI through
                // various regions, like leading/trailing/center/bottom
                DynamicIslandExpandedRegion(.leading) {
                    Text(context.attributes.teamA)
                }
                DynamicIslandExpandedRegion(.trailing) {
                    Text(context.attributes.teamB)
                }
                DynamicIslandExpandedRegion(.center) {
                    Text("\(context.attributes.name)")
                }
                DynamicIslandExpandedRegion(.bottom) {
                    Text("å½“å‰æ¯”åˆ†:\(context.state.score)")
                }
            } compactLeading: {
                Text(context.attributes.teamA)
            } compactTrailing: {
                Text(context.attributes.teamB)
            } minimal: {
                Text("ğŸ†š")
            }
            .widgetURL(URL(string: "http://www.apple.com"))
            .keylineTint(Color.red)
        }
    }
}
```

ä¸Šé¢ä»£ç ä¸­ï¼ŒLiveWidgetAttributeså®šä¹‰å®æ—¶æ´»åŠ¨æ‰€éœ€è¦çš„æ•°æ®æ¨¡å‹ï¼Œå…¶ä¸­ç›´æ¥å®šä¹‰çš„å±æ€§å¯ä»¥ç†è§£ä¸ºé™æ€çš„å±æ€§ï¼Œå³å½“å®æ—¶æ´»åŠ¨å¼€å¯æ—¶å°±ç¡®å®šçš„æ•°æ®ï¼Œä¾‹å¦‚æ¯”èµ›å‚ä¸çš„é˜Ÿä¼ï¼Œå¤–å–çš„è®¢å•ä¿¡æ¯ç­‰ã€‚å…¶ä¸­çš„ContentStateç”¨æ¥å®šä¹‰éœ€è¦æ›´æ–°çš„æ•°æ®ï¼Œä¾‹å¦‚æ¯”åˆ†æ•°æ®ï¼Œå¤–å–å‰©ä½™æ—¶é—´æ•°æ®ç­‰ã€‚

å®æ—¶æ´»åŠ¨åªèƒ½ä½¿ç”¨SwiftUIæ¥ç¼–å†™ï¼Œå¦‚ä¸Šä»£ç æ‰€ç¤ºActivityConfigurationé…ç½®å®æ—¶æ´»åŠ¨ç»„ä»¶ï¼ŒdynamicIslandå‚æ•°ç”¨æ¥å¯¹çµåŠ¨å²›è¿›è¡Œé€‚é…ã€‚

åœ¨è¿›è¡ŒçµåŠ¨å²›çš„é€‚é…æ—¶ï¼Œéœ€è¦å¯¹çµåŠ¨å²›çš„å„ç§çŠ¶æ€è¿›è¡Œé…ç½®ï¼š

1 - å±•å¼€çŠ¶æ€ä¸‹çš„çµåŠ¨å²›ã€‚

2 - é•¿æ¡çŠ¶æ€ä¸‹çš„çµåŠ¨å²›ã€‚

3 - miniçŠ¶æ€ä¸‹çš„çµåŠ¨å²›ã€‚

å±•å¼€çŠ¶æ€ä¸‹çš„çµåŠ¨å²›åˆ†ä¸ºå·¦å³ä¸­ä¸‹4éƒ¨åˆ†ï¼Œå¦‚ä¸Šä»£ç æ‰€ç¤ºå¯ä»¥å¯¹æ¯ä¸ªéƒ¨åˆ†è¿›è¡Œå¸ƒå±€ï¼Œåœ¨å¼€å¯å®æ—¶æ´»åŠ¨æ—¶ï¼Œé•¿æŒ‰çµåŠ¨å²›å¯ä»¥è¿›å…¥å±•å¼€çŠ¶æ€ï¼Œæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://oscimg.oschina.net/oscnet/up-2b4e65353eb6e43dc5f4815982b0382687d.png)

é•¿æ¡çŠ¶æ€æ˜¯çµåŠ¨å²›çš„é»˜è®¤çŠ¶æ€ï¼Œå¯ä»¥å¯¹å·¦å³ä¸¤éƒ¨åˆ†è¿›è¡Œé…ç½®ï¼Œæ•ˆæœå¦‚ä¸‹å›¾ï¼š

![](https://oscimg.oschina.net/oscnet/up-3992c046e56e2c212ba28017a3cbc03ee77.png)

å½“åŒæ—¶æœ‰å¤šä¸ªAppå¼€å¯äº†å®æ—¶æ´»åŠ¨æ—¶ï¼ŒçµåŠ¨å²›ä¸Šå°†åªå±•ç¤ºä¸€ä¸ªåœ†åœˆï¼Œæ­¤æ—¶å³æ˜¯miniçŠ¶æ€ï¼Œé€šå¸¸å¯ä»¥é…ç½®ä¸ºä¸€ä¸ªå›¾æ ‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://oscimg.oschina.net/oscnet/up-48d2520b6d9e2b52dabe1b7169ced9058ef.png)

åœ¨é”å±æˆ–æ‹‰ä¸‹é€šçŸ¥æ æ—¶ï¼Œå®æ—¶æ´»åŠ¨å°†å±•ç¤ºåœ¨æ‰€æœ‰é€šçŸ¥çš„æœ€ä¸Šæ–¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://oscimg.oschina.net/oscnet/up-e62f3a9987dbd64d2c8b45806eb467c0d21.png)

åœ¨iOS17ä¸­ï¼Œå½“è®¾å¤‡åœ¨æ¨ªå±å……ç”µæ—¶ï¼Œä¼šè‡ªåŠ¨è¿›å…¥å¾…æœºçŠ¶æ€ï¼Œå¦‚æœæœ‰å®æ—¶æ´»åŠ¨ï¼Œå®æ—¶æ´»åŠ¨å°†å æ®æ•´ä¸ªå¾…æœºé¡µé¢ï¼Œå¦‚ä¸‹å›¾ï¼š

![](https://oscimg.oschina.net/oscnet/up-d799bb20730aa0bc48a92a297af61b867be.png)

## 3 - å®æ—¶æ´»åŠ¨çš„å¼€å¯ä¸æ›´æ–°

å‰é¢æœ‰æåˆ°è¿‡ï¼Œå®æ—¶æ´»åŠ¨åªèƒ½é€šè¿‡ä¸»Appæ¥å¼€å¯ï¼ŒLiveWidgetLiveActivityç»“æ„ä½“éœ€è¦åœ¨ä¸»Appä¸­è¢«å¼•å…¥ã€‚é¦–å…ˆè®¾ç½®LiveWidgetLiveActivityçš„Target Membershipä¸ºä¸»Appä¸å°ç»„ä»¶Targetå…±äº«ï¼Œå¦‚ä¸‹å›¾ï¼š

![](https://oscimg.oschina.net/oscnet/up-a70c88441fd085551831028739c1de4773b.png)

åœ¨ä¸»Appä¸­è°ƒç”¨å¦‚ä¸‹ä»£ç æ¥è¿›è¡Œå®æ—¶æ´»åŠ¨çš„å¼€å¯ï¼š

```swift
import UIKit
// æ¡†æ¶å¼•å…¥
import ActivityKit
class ViewController: UIViewController {
    override func viewDidLoad() {
        super.viewDidLoad()
        // Do any additional setup after loading the view.
        let attri = LiveWidgetAttributes(name: "XXæ¯è‹±é›„ç”µç«æ€»å†³èµ›", teamA: "ç‹æ—é˜Ÿ", teamB: "æ–©æ˜Ÿé˜Ÿ")
        let state = LiveWidgetAttributes.ContentState(score: "2-1")
        do {
            try Activity.request(attributes: attri, contentState: state, pushType: .token) }
        catch {
            print(error)
        }
       
    }
}
```

Activicy.requestæ–¹æ³•æ¥è¯·æ±‚å¼€å¯ä¸€ä¸ªå®æ—¶æ´»åŠ¨ï¼ŒActivicyä¸­è¿˜æœ‰ä¸€äº›æ–¹æ³•ç”¨æ¥å¯¹å®æ—¶æ´»åŠ¨è¿›è¡Œæ›´æ–°å’Œè·å–æ›´æ–°å®æ—¶æ´»åŠ¨çš„PushTokenï¼Œä¸‹é¢æ˜¯å…¶ä¸­å°è£…çš„æ ¸å¿ƒå±æ€§æ–¹æ³•çš„è¯¦ç»†è§£é‡Šï¼š

```swift
public class Activity<Attributes> : Identifiable where Attributes : ActivityAttributes {
    // å¼€å¯ä¸€ä¸ªå®æ—¶æ´»åŠ¨ï¼Œå…¶ä¸­PushTypeç›®å‰åªæ”¯æŒTokenæ¨¡å‹çš„Pushæ›´æ–°
    public static func request(attributes: Attributes, content: ActivityContent<Activity<Attributes>.ContentState>, pushType: PushType? = nil) throws -> Activity<Attributes>
    // è·å–åº”ç”¨å½“å‰çš„å®æ—¶æ´»åŠ¨
    public static var activities: [Activity<Attributes>] { get }
    // å¼‚æ­¥é˜Ÿåˆ—ï¼Œç”¨æ¥ç›‘å¬å®æ—¶æ´»åŠ¨çš„æ›´æ–°
    public static var activityUpdates: Activity<Attributes>.ActivityUpdates { get }
    // å½“å‰å®æ—¶æ´»åŠ¨çš„çŠ¶æ€ï¼š æ´»è·ƒï¼Œå·²ç»“æŸï¼Œå·²ç§»é™¤
    public var activityState: ActivityState { get }
    // ç”¨æ¥ç›‘å¬çŠ¶æ€å˜æ›´
    public var activityStateUpdates: Activity<Attributes>.ActivityStateUpdates { get }
    // é€šè¿‡Pushæ›´æ–°å®æ—¶æ´»åŠ¨æ—¶çš„PushToken
    public var pushToken: Data? { get }
    // å¼‚æ­¥çš„å¯¹å®æ—¶æ´»åŠ¨çŠ¶æ€è¿›è¡Œæ›´æ–°
    public func update(using contentState: Activity<Attributes>.ContentState) async
    public func update(_ content: ActivityContent<Activity<Attributes>.ContentState>) async
    public func update(using contentState: Activity<Attributes>.ContentState, alertConfiguration: AlertConfiguration? = nil) async
    public func update(_ content: ActivityContent<Activity<Attributes>.ContentState>, alertConfiguration: AlertConfiguration? = nil) async
    // ç»“æŸä¸€ä¸ªå®æ—¶æ´»åŠ¨
    public func end(using contentState: Activity<Attributes>.ContentState? = nil, dismissalPolicy: ActivityUIDismissalPolicy = .default) async
    public func end(_ content: ActivityContent<Activity<Attributes>.ContentState>?, dismissalPolicy: ActivityUIDismissalPolicy = .default) async
}
```

æœ€åï¼Œéœ€è¦æ³¨æ„ï¼Œæ­¤å¤„è¿›è¡Œæ›´æ–°å®æ—¶æ´»åŠ¨çš„Pushå¿…é¡»æ˜¯åŸºäºTokenéªŒè¯çš„APNsï¼Œä¸èƒ½æ˜¯åŸºäºè¯ä¹¦éªŒè¯çš„APNsï¼Œæ­¤å¤„çš„Tokenä¸æ˜¯ä»Applicationæ¥å£æ‹¿åˆ°çš„Device Tokenï¼Œè€Œæ˜¯ä»Apple Developeråå°åˆ›å»ºçš„é‰´æƒTokenï¼Œå¦å¤–ï¼ŒåŸºäºTokençš„Pushè®¤è¯è¦æ¯”åŸºäºè¯ä¹¦çš„æ›´åŠ æ–¹ä¾¿ï¼Œä¸”æ— éœ€å…³å¿ƒè¿‡æœŸæ—¶é—´ï¼Œå¦‚æœä½ çš„åº”ç”¨çš„APNsç›®å‰ä¾ç„¶æ˜¯åŸºäºè¯ä¹¦çš„ï¼Œåˆ™éœ€è¦è¿›è¡Œæ”¹é€ åæ‰èƒ½ä½¿ç”¨å…¶æ¥æ›´æ–°å®æ—¶æ´»åŠ¨ã€‚