<script src="https://eqcn.ajz.miesnfu.com/wp-content/plugins/wp-3d-pony/live2dw/lib/L2Dwidget.min.js"></script> 
<script>
　　let models = [
    "https://unpkg.com/live2d-widget-model-chitose@1.0.5/assets/chitose.model.json",
    "https://unpkg.com/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json",
    "https://unpkg.com/live2d-widget-model-koharu@1.0.5/assets/koharu.model.json",
    "https://unpkg.com/live2d-widget-model-haruto@1.0.5/assets/haruto.model.json",
    "https://unpkg.com/live2d-widget-model-miku@1.0.5/assets/miku.model.json",
    "https://unpkg.com/live2d-widget-model-z16@1.0.5/assets/z16.model.json"
];
let m = models[Math.round(Math.random()*5)];
　　L2Dwidget.init({ 
　　"model": {jsonPath:m,"scale": 1 }, 
　　"display": { "position": "left", "width": 200, "height": 300,"hOffset": 0, "vOffset": -20 }, 
　　"mobile": { "show": true, "scale": 0.5 }, 
　　"react": { "opacityDefault": 0.7, "opacityOnHover": 0.2 } });
</script> 
<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="珲少的技术博客">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://huishao.cc">
    <meta name="referrer" content="no-referrer">
    <!--SEO-->

<meta name="description" content="珲少的技术博客">



<meta name="keywords" content="珲少">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">
    <!--Title-->


<title>聊聊iOS中的Mach-O | 珲少的技术博客</title>


    <link rel="alternate" href="/atom.xml" title="珲少的技术博客" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    





    
</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  style="background-image:url(http://7xpw2b.com1.z0.glb.clouddn.com/hexo-sinppet/img/banner.png)"  >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='珲少'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                <h2> 学如逆水行舟 </h2>
            
    	</div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://huishao.cc">珲少的技术博客</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>主页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/archives/"><i class="fa "></i>归档</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="聊聊iOS中的Mach-O">
            
	            聊聊iOS中的Mach-O
            
        </h1>
        <div class="post-meta">
    
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a href="/categories/iOS之逻辑初窥">
            iOS之逻辑初窥
        </a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
                
            
        </span>
    </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2022/08/17</span>
        </span>
    
</div>

            
            
    </div>
    
    <div class="post-body post-content">
        <h1 id="聊聊iOS中的Mach-O"><a href="#聊聊iOS中的Mach-O" class="headerlink" title="聊聊iOS中的Mach-O"></a>聊聊iOS中的Mach-O</h1><h2 id="一-关于Mach-O"><a href="#一-关于Mach-O" class="headerlink" title="一 关于Mach-O"></a>一 关于Mach-O</h2><p>Mach-O的全称为Mach Object，是OS X与iOS上的一种可执行文件格式。Mach本身指一种操作系统的微内核标准，被用于OS X与iOS系统的内核中。相信对于移动端的iOS开发者来说，对Mach-O文件一定不陌生，我们编译打包的iOS IPA文件，内部其实就有一个可执行的Mach-O文件，我们开发的framework和.a等动态库静态库中，也会包含Mach-O文件，本篇文章，我们就来详细看看Mach-O中究竟放的是什么，Mach-O的结构是怎样的。</p>
<h2 id="二-Mach-O头信息"><a href="#二-Mach-O头信息" class="headerlink" title="二 Mach-O头信息"></a>二 Mach-O头信息</h2><p>Mach-O是一种文件格式，我们知道很多文件类型有包含有文件头，例如图片文件头中可能会包含图片的格式，编码方式等，压缩文件的文件头中包含压缩参数等等。相比，Mach-O是一种更加复杂的文件，其文件头中提供的信息也更多。我们可以在Github上找到一款开源的Mach-O文件阅读软件：MachOView。可以尝试用其打开任意一个编译好的IPA包中的Mach-O文件，例如：</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-62bfd2a90912f17761ca55dc89704e75e2b.png" alt></p>
<p>可以看到，格式化后的文件内容中，有一项是Mach64 Header，这一项内容也是在Mach-O文件的最前部，这里就是Mach-O文件头。</p>
<p>关于Mach-O头部，我们可以在usr/include/mach-o/Loader.h文件中找到对应的定义，如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 32位的Mach-O头</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mach_header</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	magic;		<span class="comment">/* mach magic number identifier */</span></span><br><span class="line">	<span class="keyword">cpu_type_t</span>	cputype;	<span class="comment">/* cpu specifier */</span></span><br><span class="line">	<span class="keyword">cpu_subtype_t</span>	cpusubtype;	<span class="comment">/* machine specifier */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	filetype;	<span class="comment">/* type of file */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	ncmds;		<span class="comment">/* number of load commands */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	sizeofcmds;	<span class="comment">/* the size of all the load commands */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	flags;		<span class="comment">/* flags */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 64位的Mach-O头</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mach_header_64</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	magic;		<span class="comment">/* mach magic number identifier */</span></span><br><span class="line">	<span class="keyword">cpu_type_t</span>	cputype;	<span class="comment">/* cpu specifier */</span></span><br><span class="line">	<span class="keyword">cpu_subtype_t</span>	cpusubtype;	<span class="comment">/* machine specifier */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	filetype;	<span class="comment">/* type of file */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	ncmds;		<span class="comment">/* number of load commands */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	sizeofcmds;	<span class="comment">/* the size of all the load commands */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	flags;		<span class="comment">/* flags */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	reserved;	<span class="comment">/* reserved */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以看到，32位的Mach-O和64位的Mach-O最大的区别只在于64位的多了一个reserved字段，此字段当前并没有特殊意义，其预留给未来使用。下面我们来详细看下这些字段的意义。</p>
<p><strong>1.magic</strong></p>
<p>从其数据类型uint32_t也可以看出，magic占32个二进制位。顾名思义，这个字段是一个魔数，用来区分当前Mach-O是32位的还是64位的，有两个宏对此魔数的值进行了定义：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 32位</span></span><br><span class="line"><span class="meta">#define	MH_MAGIC	0xfeedface</span></span><br><span class="line"><span class="comment">// 64位</span></span><br><span class="line"><span class="meta">#define MH_MAGIC_64 0xfeedfacf</span></span><br></pre></td></tr></table></figure>
<p>你可以看下MachOView软件格式化后的此字段的值，是否和这些宏是对应的。</p>
<p><strong>2.cputype</strong></p>
<p>此字段占32个二进制位，用来描述CPU类型，相关宏定义在mach/machine.h头文件中，如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_TYPE_ANY            ((cpu_type_t) -1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_TYPE_VAX            ((cpu_type_t) 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_TYPE_MC680x0        ((cpu_type_t) 6)</span></span><br><span class="line"><span class="comment">// 模拟器和Maac一般为此类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_TYPE_X86            ((cpu_type_t) 7)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_TYPE_I386           CPU_TYPE_X86 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_TYPE_X86_64         (CPU_TYPE_X86 | CPU_ARCH_ABI64)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_TYPE_MC98000        ((cpu_type_t) 10)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_TYPE_HPPA           ((cpu_type_t) 11)</span></span><br><span class="line"><span class="comment">// iPhone真机一般为此类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_TYPE_ARM            ((cpu_type_t) 12)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_TYPE_ARM64          (CPU_TYPE_ARM | CPU_ARCH_ABI64)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_TYPE_ARM64_32       (CPU_TYPE_ARM | CPU_ARCH_ABI64_32)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_TYPE_MC88000        ((cpu_type_t) 13)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_TYPE_SPARC          ((cpu_type_t) 14)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_TYPE_I860           ((cpu_type_t) 15)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_TYPE_POWERPC                ((cpu_type_t) 18)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_TYPE_POWERPC64              (CPU_TYPE_POWERPC | CPU_ARCH_ABI64)</span></span><br></pre></td></tr></table></figure>
<p>其中的cpu_type_t其实就是int类型的别名。</p>
<p><strong>3.cpusubtype</strong></p>
<p>CPU子类型，定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MASK        0xff000000 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_LIB64       0x80000000 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_PTRAUTH_ABI 0x80000000 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ANY         ((cpu_subtype_t) -1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MULTIPLE            ((cpu_subtype_t) -1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_LITTLE_ENDIAN       ((cpu_subtype_t) 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_BIG_ENDIAN          ((cpu_subtype_t) 1)</span></span><br><span class="line"><span class="comment">// VAX的子类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_VAX_ALL     ((cpu_subtype_t) 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_VAX780      ((cpu_subtype_t) 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_VAX785      ((cpu_subtype_t) 2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_VAX750      ((cpu_subtype_t) 3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_VAX730      ((cpu_subtype_t) 4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_UVAXI       ((cpu_subtype_t) 5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_UVAXII      ((cpu_subtype_t) 6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_VAX8200     ((cpu_subtype_t) 7)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_VAX8500     ((cpu_subtype_t) 8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_VAX8600     ((cpu_subtype_t) 9)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_VAX8650     ((cpu_subtype_t) 10)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_VAX8800     ((cpu_subtype_t) 11)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_UVAXIII     ((cpu_subtype_t) 12)</span></span><br><span class="line"><span class="comment">// MC680子类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MC680x0_ALL         ((cpu_subtype_t) 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MC68030             ((cpu_subtype_t) 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MC68040             ((cpu_subtype_t) 2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MC68030_ONLY        ((cpu_subtype_t) 3)</span></span><br><span class="line"><span class="comment">// I386子类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_INTEL(f, m) ((cpu_subtype_t) (f) + ((m) &lt;&lt; 4))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_I386_ALL                    CPU_SUBTYPE_INTEL(3, 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_386                                 CPU_SUBTYPE_INTEL(3, 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_486                                 CPU_SUBTYPE_INTEL(4, 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_486SX                               CPU_SUBTYPE_INTEL(4, 8) <span class="comment">// 8 &lt;&lt; 4 = 128</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_586                                 CPU_SUBTYPE_INTEL(5, 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_PENT        CPU_SUBTYPE_INTEL(5, 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_PENTPRO     CPU_SUBTYPE_INTEL(6, 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_PENTII_M3   CPU_SUBTYPE_INTEL(6, 3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_PENTII_M5   CPU_SUBTYPE_INTEL(6, 5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_CELERON                             CPU_SUBTYPE_INTEL(7, 6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_CELERON_MOBILE              CPU_SUBTYPE_INTEL(7, 7)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_PENTIUM_3                   CPU_SUBTYPE_INTEL(8, 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_PENTIUM_3_M                 CPU_SUBTYPE_INTEL(8, 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_PENTIUM_3_XEON              CPU_SUBTYPE_INTEL(8, 2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_PENTIUM_M                   CPU_SUBTYPE_INTEL(9, 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_PENTIUM_4                   CPU_SUBTYPE_INTEL(10, 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_PENTIUM_4_M                 CPU_SUBTYPE_INTEL(10, 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ITANIUM                             CPU_SUBTYPE_INTEL(11, 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ITANIUM_2                   CPU_SUBTYPE_INTEL(11, 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_XEON                                CPU_SUBTYPE_INTEL(12, 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_XEON_MP                             CPU_SUBTYPE_INTEL(12, 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_INTEL_FAMILY(x)     ((x) &amp; 15)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_INTEL_FAMILY_MAX    15</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_INTEL_MODEL(x)      ((x) &gt;&gt; 4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_INTEL_MODEL_ALL     0</span></span><br><span class="line"><span class="comment">// X86子类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_X86_ALL             ((cpu_subtype_t)3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_X86_64_ALL          ((cpu_subtype_t)3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_X86_ARCH1           ((cpu_subtype_t)4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_X86_64_H            ((cpu_subtype_t)8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_THREADTYPE_INTEL_HTT        ((cpu_threadtype_t) 1)</span></span><br><span class="line"><span class="comment">// MIPS子类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MIPS_ALL    ((cpu_subtype_t) 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MIPS_R2300  ((cpu_subtype_t) 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MIPS_R2600  ((cpu_subtype_t) 2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MIPS_R2800  ((cpu_subtype_t) 3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MIPS_R2000a ((cpu_subtype_t) 4)     <span class="comment">/* pmax */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MIPS_R2000  ((cpu_subtype_t) 5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MIPS_R3000a ((cpu_subtype_t) 6)     <span class="comment">/* 3max */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MIPS_R3000  ((cpu_subtype_t) 7)</span></span><br><span class="line"><span class="comment">// MC98000子类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MC98000_ALL ((cpu_subtype_t) 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MC98601     ((cpu_subtype_t) 1)</span></span><br><span class="line"><span class="comment">// HPPA子类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_HPPA_ALL            ((cpu_subtype_t) 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_HPPA_7100           ((cpu_subtype_t) 0) <span class="comment">/* compat */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_HPPA_7100LC         ((cpu_subtype_t) 1)</span></span><br><span class="line"><span class="comment">// MC88000子类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MC88000_ALL ((cpu_subtype_t) 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MC88100     ((cpu_subtype_t) 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_MC88110     ((cpu_subtype_t) 2)</span></span><br><span class="line"><span class="comment">// SPARC子类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_SPARC_ALL           ((cpu_subtype_t) 0)</span></span><br><span class="line"><span class="comment">// I860子类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_I860_ALL    ((cpu_subtype_t) 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_I860_860    ((cpu_subtype_t) 1)</span></span><br><span class="line"><span class="comment">// PowerPC子类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_POWERPC_ALL         ((cpu_subtype_t) 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_POWERPC_601         ((cpu_subtype_t) 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_POWERPC_602         ((cpu_subtype_t) 2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_POWERPC_603         ((cpu_subtype_t) 3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_POWERPC_603e        ((cpu_subtype_t) 4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_POWERPC_603ev       ((cpu_subtype_t) 5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_POWERPC_604         ((cpu_subtype_t) 6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_POWERPC_604e        ((cpu_subtype_t) 7)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_POWERPC_620         ((cpu_subtype_t) 8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_POWERPC_750         ((cpu_subtype_t) 9)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_POWERPC_7400        ((cpu_subtype_t) 10)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_POWERPC_7450        ((cpu_subtype_t) 11)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_POWERPC_970         ((cpu_subtype_t) 100)</span></span><br><span class="line"><span class="comment">// ARM子类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM_ALL             ((cpu_subtype_t) 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM_V4T             ((cpu_subtype_t) 5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM_V6              ((cpu_subtype_t) 6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM_V5TEJ           ((cpu_subtype_t) 7)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM_XSCALE          ((cpu_subtype_t) 8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM_V7              ((cpu_subtype_t) 9)  <span class="comment">/* ARMv7-A and ARMv7-R */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM_V7F             ((cpu_subtype_t) 10) <span class="comment">/* Cortex A9 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM_V7S             ((cpu_subtype_t) 11) <span class="comment">/* Swift */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM_V7K             ((cpu_subtype_t) 12)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM_V8              ((cpu_subtype_t) 13)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM_V6M             ((cpu_subtype_t) 14) <span class="comment">/* Not meant to be run under xnu */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM_V7M             ((cpu_subtype_t) 15) <span class="comment">/* Not meant to be run under xnu */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM_V7EM            ((cpu_subtype_t) 16) <span class="comment">/* Not meant to be run under xnu */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM_V8M             ((cpu_subtype_t) 17) <span class="comment">/* Not meant to be run under xnu */</span></span></span><br><span class="line"><span class="comment">// ARM64子类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM64_ALL           ((cpu_subtype_t) 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM64_V8            ((cpu_subtype_t) 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM64E              ((cpu_subtype_t) 2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM64_PTR_AUTH_MASK 0x0f000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM64_PTR_AUTH_VERSION(x) (((x) &amp; CPU_SUBTYPE_ARM64_PTR_AUTH_MASK) &gt;&gt; 24)</span></span><br><span class="line"><span class="comment">// ARM64_32子类型</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM64_32_ALL        ((cpu_subtype_t) 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CPU_SUBTYPE_ARM64_32_V8 ((cpu_subtype_t) 1)</span></span><br></pre></td></tr></table></figure>
<p><strong>4.filetype</strong></p>
<p>此字段标记Mach-O文件的具体类型，例如当前Mach-O是可执行文件还是库文件等，此字段占32个二进制位，值定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可重定位的目标文件，编译源码得到的中间结果</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	MH_OBJECT	0x1	</span></span><br><span class="line"><span class="comment">// 可执行的二进制文件，iOS应用IPA包中的可执行Mach-O就是此类型的</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	MH_EXECUTE	0x2</span></span><br><span class="line"><span class="comment">// 修复后的VM共享库文件</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	MH_FVMLIB	0x3</span></span><br><span class="line"><span class="comment">// 核心转储文件</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	MH_CORE		0x4	</span></span><br><span class="line"><span class="comment">// 预加载的可执行文件</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	MH_PRELOAD	0x5</span></span><br><span class="line"><span class="comment">// 动态库文件</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	MH_DYLIB	0x6	</span></span><br><span class="line"><span class="comment">// 动态链接器文件</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	MH_DYLINKER	0x7	</span></span><br><span class="line"><span class="comment">// 插件文件，非独立的二进制文件</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	MH_BUNDLE	0x8</span></span><br><span class="line"><span class="comment">// 仅用于静态链接的共享库文件</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	MH_DYLIB_STUB	0x9</span></span><br><span class="line"><span class="comment">// 辅助的符号文件及调试信息</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	MH_DSYM		0xa</span></span><br><span class="line"><span class="comment">// 内核扩展</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	MH_KEXT_BUNDLE	0xb</span></span><br><span class="line"><span class="comment">// 其他Mach-O组成的集合</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_FILESET	0xc</span></span><br></pre></td></tr></table></figure>
<p><strong>5.ncmds</strong></p>
<p>此字段描述需要加载的命令条数，与Mach-O文件中的Load Commands段中的数据对应。</p>
<p><strong>6.sizeofcmds</strong></p>
<p>与Mach-O文件中的Load Commands段中的数据对应，标记Load Commands段的长度。</p>
<p><strong>7.flags</strong></p>
<p>标志位字段，标记当前Mach-O文件的一些重要信息，这些flags是以二进制位或的关系定义的，也就是说可以同时拥有多个标记。定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 未带未定义的符号，没有进一步的链接依赖关系</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	MH_NOUNDEFS	0x1	</span></span><br><span class="line"><span class="comment">// 目标文件是增量链接的输出，不能再次被链接</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	MH_INCRLINK	0x2	</span></span><br><span class="line"><span class="comment">// 目标文件是动态链接器的输入，不能再次静态链接</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_DYLDLINK	0x4</span></span><br><span class="line"><span class="comment">// 加载时，对象文件的未定义引用由动态链接器绑定</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_BINDATLOAD	0x8</span></span><br><span class="line"><span class="comment">// 该文件预先绑定了其动态未定义引用</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_PREBOUND	0x10</span></span><br><span class="line"><span class="comment">// 目标文件的只读段与可读写段进行了区分</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_SPLIT_SEGS	0x20</span></span><br><span class="line"><span class="comment">// 延迟init</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_LAZY_INIT	0x40</span></span><br><span class="line"><span class="comment">// 两层名称绑定</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_TWOLEVEL	0x80</span></span><br><span class="line"><span class="comment">// 扁平名称绑定</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_FORCE_FLAT	0x100</span></span><br><span class="line"><span class="comment">// 子image中没有多定义的符号</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_NOMULTIDEFS	0x200</span></span><br><span class="line"><span class="comment">// 不要让dyld将此可执行文件通知预绑定代理</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_NOFIXPREBINDING 0x400</span></span><br><span class="line"><span class="comment">// 二进制文件不是预绑定的，但可以重新进行预绑定</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_PREBINDABLE  0x800 </span></span><br><span class="line"><span class="comment">// 指示此二进制文件绑定到其依赖库的所有两级命名空间模块</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_ALLMODSBOUND 0x1000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_SUBSECTIONS_VIA_SYMBOLS 0x2000</span></span><br><span class="line"><span class="comment">// 二进制文件已被规范化为非绑定操作</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_CANONICAL    0x4000</span></span><br><span class="line"><span class="comment">// 二进制文件使用了弱符号</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_WEAK_DEFINES	0x8000</span></span><br><span class="line"><span class="comment">// 最终链接的image使用了弱符号</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_BINDS_TO_WEAK 0x10000</span></span><br><span class="line"><span class="comment">// 允许栈可执行</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_ALLOW_STACK_EXECUTION 0x20000</span></span><br><span class="line"><span class="comment">// 当设置此位时，二进制文件声明它可以安全地用于uid为零的进程</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_ROOT_SAFE 0x40000  </span></span><br><span class="line"><span class="comment">// 当设置该位时，二进制文件声明它可以在issetugid为true的进程中安全使用</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_SETUID_SAFE 0x80000 </span></span><br><span class="line"><span class="comment">// 当在dylib上设置此位时，静态链接器不需要检查依赖的dylib，以查看是否有重新导出的依赖dylib</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_NO_REEXPORTED_DYLIBS 0x100000</span></span><br><span class="line"><span class="comment">// 对可执行文件启用地址空间布局随机化</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	MH_PIE 0x200000	</span></span><br><span class="line"><span class="comment">// 仅适用于dylibs。当链接到设置了此位的dylib时，如果没有从dylib引用符号，则静态链接器将自动不对dylib创建LC_LOAD_dylib加载命令</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	MH_DEAD_STRIPPABLE_DYLIB 0x400000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_HAS_TLV_DESCRIPTORS 0x800000</span></span><br><span class="line"><span class="comment">// 将堆标记为不可执行</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_NO_HEAP_EXECUTION 0x1000000</span></span><br><span class="line"><span class="comment">// 扩展应用中使用</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_APP_EXTENSION_SAFE 0x02000000</span></span><br><span class="line"><span class="comment">// nlist符号表中列出的外部符号不包括dyld信息中列出的所有符号</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	MH_NLIST_OUTOFSYNC_WITH_DYLDINFO 0x04000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	MH_SIM_SUPPORT 0x08000000</span></span><br><span class="line"><span class="comment">// 仅适用于dylibs。设置该位时，dylib是dyld共享缓存的一部分，而不是文件系统中的松散缓存。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_DYLIB_IN_CACHE 0x80000000</span></span><br></pre></td></tr></table></figure>
<p>Mach-O文件头的内容大致就只有这些，上面我们提到过，ncmds和sizeofcmds描述了加载命令的条数和加载命令的内容大小，下面我们就来看下加载命令。</p>
<h2 id="三-加载命令"><a href="#三-加载命令" class="headerlink" title="三 加载命令"></a>三 加载命令</h2><p>在Mach-O文件中，加载命令段紧跟在Mach-O头数据后面，头数据中的字段告知了我们加载命令的条数和大小，通过这两个字段来具体的进行命令的解析和执行。</p>
<p>我们现在MachOView中简单浏览下这部分的数据结构，如下图：</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-c4cfef8f7561139d74b632d6388e38d8cba.png" alt></p>
<p>可以看到，每条加载命令的开头结构都是一样的，即命令类型和当前命令的长度大小。其实，在loader.h头文件中有定义一个结构体来描述加载命令，如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">load_command</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> cmd;		</span><br><span class="line">	<span class="keyword">uint32_t</span> cmdsize;	</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以看到，每条加载命令在解析时，首先会获取到cmd和cmdsize，cmd用来标记加载命令是什么，cmdsize指明当前加载命令的字节长度，通过这两个字段，可以对命令进行完整的解析。</p>
<p>下面列举了常见的命令类型，对应的宏定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将文件中的段（32位）映射到进程地址空间中</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_SEGMENT	0x1</span></span><br><span class="line"><span class="comment">// 将文件中的段（64位）映射到进程地址空间中</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_SEGMENT_64	0x19</span></span><br><span class="line"><span class="comment">// 链接编辑stab符号表信息</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_SYMTAB	0x2</span></span><br><span class="line"><span class="comment">// 链接编辑gdb符号表信息</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_SYMSEG	0x3</span></span><br><span class="line"><span class="comment">// 开启一个Mach线程，不开辟栈</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_THREAD	0x4</span></span><br><span class="line"><span class="comment">// 开启一个UNIX线程</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_UNIXTHREAD	0x5</span></span><br><span class="line"><span class="comment">// 加载指定的固定VM共享库</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_LOADFVMLIB	0x6	</span></span><br><span class="line"><span class="comment">// 修复了VM共享库标识</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_IDFVMLIB	0x7</span></span><br><span class="line"><span class="comment">// 对象标识信息</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_IDENT	0x8</span></span><br><span class="line"><span class="comment">// 固定VM文件包含</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_FVMFILE 0x9</span></span><br><span class="line"><span class="comment">// prepage命令</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_PREPAGE      0xa</span></span><br><span class="line"><span class="comment">// 动态链接编辑符号表信息 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_DYSYMTAB	0xb</span></span><br><span class="line"><span class="comment">// 加载动态链接的共享库</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_LOAD_DYLIB	0xc</span></span><br><span class="line"><span class="comment">// 动态链接共享库标识</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_ID_DYLIB	0xd</span></span><br><span class="line"><span class="comment">// 加载动态链接器</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_LOAD_DYLINKER 0xe</span></span><br><span class="line"><span class="comment">// 动态链接器标识</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_ID_DYLINKER	0xf</span></span><br><span class="line"><span class="comment">// 动态预绑定的模块</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_PREBOUND_DYLIB 0x10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面的命令与链接共享库有关</span></span><br><span class="line"><span class="comment">// image routines</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_ROUTINES	0x11	<span class="comment">/* image routines */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_ROUTINES_64	0x1a</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_SUB_FRAMEWORK 0x12	<span class="comment">/* sub framework */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_SUB_UMBRELLA 0x13	<span class="comment">/* sub umbrella */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_SUB_CLIENT	0x14	<span class="comment">/* sub client */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_SUB_LIBRARY  0x15	<span class="comment">/* sub library */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_TWOLEVEL_HINTS 0x16	<span class="comment">/* two-level namespace lookup hints */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_PREBIND_CKSUM  0x17	<span class="comment">/* prebind checksum */</span></span></span><br><span class="line"><span class="comment">// 加载允许丢失的动态链接共享库</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_LOAD_WEAK_DYLIB (0x18 | LC_REQ_DYLD)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 唯一的UUID，表示当前二进制文件</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_UUID		0x1b</span></span><br><span class="line"><span class="comment">// 进行本地代码签名</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_CODE_SIGNATURE 0x1d</span></span><br><span class="line"><span class="comment">// 本地拆分段</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_SEGMENT_SPLIT_INFO 0x1e </span></span><br><span class="line"><span class="comment">// 加载并重新导出dylib</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_REEXPORT_DYLIB (0x1f | LC_REQ_DYLD)</span></span><br><span class="line"><span class="comment">// 将dylib加载延迟至首次使用</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_LAZY_LOAD_DYLIB 0x20</span></span><br><span class="line"><span class="comment">// 加密的段信息</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_ENCRYPTION_INFO 0x21</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_ENCRYPTION_INFO_64 0x2C</span></span><br><span class="line"><span class="comment">// 压缩的dyld信息</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_DYLD_INFO 	0x22</span></span><br><span class="line"><span class="comment">// 仅限压缩的dyld信息</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_DYLD_INFO_ONLY (0x22|LC_REQ_DYLD)</span></span><br><span class="line"><span class="comment">// 向上加载dylib</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	LC_LOAD_UPWARD_DYLIB (0x23 | LC_REQ_DYLD)</span></span><br><span class="line"><span class="comment">// 为MacOSX最小操作系统版本构建</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_VERSION_MIN_MACOSX 0x24</span></span><br><span class="line"><span class="comment">// 为iOS最小操作系统版本构建</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_VERSION_MIN_IPHONEOS 0x25</span></span><br><span class="line"><span class="comment">// 为TVOS最小操作系统版本构建</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_VERSION_MIN_TVOS 0x2F</span></span><br><span class="line"><span class="comment">// 为WATCHOS最小操作系统版本构建</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_VERSION_MIN_WATCHOS 0x30</span></span><br><span class="line"><span class="comment">// 压缩的函数起始地址表</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_FUNCTION_STARTS 0x26</span></span><br><span class="line"><span class="comment">// dyld要像环境变量一样处理的字符串</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_DYLD_ENVIRONMENT 0x27</span></span><br><span class="line"><span class="comment">// 同LC_UNIXTHREAD</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_MAIN (0x28|LC_REQ_DYLD)</span></span><br><span class="line"><span class="comment">// __text段中的非说明表</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_DATA_IN_CODE 0x29</span></span><br><span class="line"><span class="comment">// 用于生成二进制文件的源代码版本</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_SOURCE_VERSION 0x2A</span></span><br><span class="line"><span class="comment">// 从链接的dylibs复制的代码签名DR</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_DYLIB_CODE_SIGN_DRS 0x2B</span></span><br><span class="line"><span class="comment">// MH_OBJECT文件中的链接器选项</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_LINKER_OPTION 0x2D </span></span><br><span class="line"><span class="comment">// MH_OBJECT文件中的优化提示</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_LINKER_OPTIMIZATION_HINT 0x2E</span></span><br><span class="line"><span class="comment">// Mach-O文件中包含的任意数据</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_NOTE 0x31</span></span><br><span class="line"><span class="comment">// 为平台最小操作系统版本构建</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_BUILD_VERSION 0x32</span></span><br><span class="line"><span class="comment">// 与linkedit_data_command一起使用</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_DYLD_EXPORTS_TRIE (0x33 | LC_REQ_DYLD)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_DYLD_CHAINED_FIXUPS (0x34 | LC_REQ_DYLD)</span></span><br><span class="line"><span class="comment">// 与fileset_entry_command一起使用</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LC_FILESET_ENTRY (0x35 | LC_REQ_DYLD)</span></span><br></pre></td></tr></table></figure>
<p>在加载命令段，通过解析出每条命令的类型和大小，就可以方便的获取到命令中具体的值，准确来说，一条加载命令是由类型，大小和值三部分组成的。不同类型的命令对应的值解析出来的结构也不同，下面我们来介绍几个常见的命令。</p>
<p><strong>1.LC_SEGMENT/LS_SEGMENT_64</strong></p>
<p>通过我们编译的iOS空项目的Mach-O文件可以看到，其中包含了很多条LS_SEGMENT_64加载命令，此命令描述了内核应该如何设置当前应用进行的内存空间，这些段将直接从Mach-O文件中对应的位置加载到内存里。LS_SEGMENT_64命令的值的结构定义如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> segment_command &#123; <span class="comment">/* for 32-bit architectures */</span></span><br><span class="line">	uint32_t	cmd;		<span class="comment">/* LC_SEGMENT */</span></span><br><span class="line">	uint32_t	cmdsize;	<span class="comment">/* includes sizeof section structs */</span></span><br><span class="line">	<span class="keyword">char</span>		segname[<span class="number">16</span>];	<span class="comment">/* segment name */</span></span><br><span class="line">	uint32_t	vmaddr;		<span class="comment">/* memory address of this segment */</span></span><br><span class="line">	uint32_t	vmsize;		<span class="comment">/* memory size of this segment */</span></span><br><span class="line">	uint32_t	fileoff;	<span class="comment">/* file offset of this segment */</span></span><br><span class="line">	uint32_t	filesize;	<span class="comment">/* amount to map from the file */</span></span><br><span class="line">	vm_prot_t	maxprot;	<span class="comment">/* maximum VM protection */</span></span><br><span class="line">	vm_prot_t	initprot;	<span class="comment">/* initial VM protection */</span></span><br><span class="line">	uint32_t	nsects;		<span class="comment">/* number of sections in segment */</span></span><br><span class="line">	uint32_t	flags;		<span class="comment">/* flags */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> segment_command_64 &#123; <span class="comment">/* for 64-bit architectures */</span></span><br><span class="line">	uint32_t	cmd;		<span class="comment">/* LC_SEGMENT_64 */</span></span><br><span class="line">	uint32_t	cmdsize;	<span class="comment">/* includes sizeof section_64 structs */</span></span><br><span class="line">	<span class="keyword">char</span>		segname[<span class="number">16</span>]; <span class="comment">// 段的名称</span></span><br><span class="line">	uint64_t	vmaddr;		 <span class="comment">// 虚拟物理地址</span></span><br><span class="line">	uint64_t	vmsize;		 <span class="comment">// 为此段分配的虚拟内存大小</span></span><br><span class="line">	uint64_t	fileoff;	 <span class="comment">// 此段在文件中的偏移量</span></span><br><span class="line">	uint64_t	filesize;	 <span class="comment">// 此段在文件中占用的字节数</span></span><br><span class="line">	vm_prot_t	maxprot;	 <span class="comment">// 段的页面所需要的最高内存保护</span></span><br><span class="line">	vm_prot_t	initprot;	 <span class="comment">// 段页面初始时的内存保护</span></span><br><span class="line">	uint32_t	nsects;		 <span class="comment">// 段中区（section）的数量</span></span><br><span class="line">	uint32_t	flags;		 <span class="comment">// 标记位</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以看到，每个段加载命令中都提供了段的基本信息，包括名称，偏移地址，字节数，以及段有包含的分区的个数，通过此命令，进程虚拟内存的设置就变得很简单，只需要根据指令来读取信息并加载到内存即可。关于段的分析我们会在后面小节做具体的介绍。</p>
<p><strong>2.LC_MAIN/LS_UNIXTHREAD</strong></p>
<p>当所有库加载完成后，此命令用来进行二进制程序的主线程启动。</p>
<p><strong>3.LC_CODE_SIGNATURE</strong></p>
<p>Mach-O包含的数字签名，如果此签名与代码不匹配，则进程会被强制关闭。LC_CODE_SIGNATURE命令的结构如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">linkedit_data_command</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span>	cmd;		<span class="comment">/* LC_CODE_SIGNATURE, LC_SEGMENT_SPLIT_INFO,</span></span><br><span class="line"><span class="comment">				   LC_FUNCTION_STARTS, LC_DATA_IN_CODE,</span></span><br><span class="line"><span class="comment">				   LC_DYLIB_CODE_SIGN_DRS,</span></span><br><span class="line"><span class="comment">				   LC_LINKER_OPTIMIZATION_HINT,</span></span><br><span class="line"><span class="comment">				   LC_DYLD_EXPORTS_TRIE, or</span></span><br><span class="line"><span class="comment">				   LC_DYLD_CHAINED_FIXUPS. */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>	cmdsize;	<span class="comment">/* sizeof(struct linkedit_data_command) */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>	dataoff;	<span class="comment">// 地址偏移量</span></span><br><span class="line">    <span class="keyword">uint32_t</span>	datasize;	<span class="comment">// 字节数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>此命令的结构是一个复用的结构，很多命令都能解析成此结构，其中dataoff标记从文件的何处开始读取签名，datasize标记签名所占字节数。我们可以通过一个Mach-O文件来验证下，首先在加载命令段找到LC_CODE_SIGNATURE命令，如下：</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-299f3c568dd31425b0e482607d177a8c8b9.png" alt></p>
<p>可以看到，其offset为E8A0，size为4B00，相加后为133A0，因此我们可以得知，签名所在的位置为偏移地址为E8A0的地方，最终结束的地址为133A0，找到Code Signature段进行验证，如下：</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-92a4da870e409cb0d2c700474388f991faa.png" alt></p>
<p><img src="https://oscimg.oschina.net/oscnet/up-fb7c6d706737d6d26db9bd08b8d8f46ed00.png" alt></p>
<p>可以看到，Code Signature段的起始偏移位置就是E8A0，最后4个字节的偏移位置为13390，再加上最后的4个字节，结尾的位置刚好为133A0，和我们计算的一致。</p>
<p>并非只有LC_CODE_SIGNATURE命令是采用偏移量和字节数的方式来进行加载，这种值结构的命令都是一样的逻辑，这里就不再赘述。</p>
<p><strong>4.LC_SYMTAB</strong></p>
<p>此命令用来加载此Mach-O文件的符号表，此命令中包含了symbol table和string table在Mach-O文件中的位置，LC_SYMTAB命令的值定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">symtab_command</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	cmd;		<span class="comment">/* LC_SYMTAB */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	cmdsize;	<span class="comment">/* sizeof(struct symtab_command) */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	symoff;		<span class="comment">// 符号表起始位置的偏移量</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	nsyms;		<span class="comment">// 符号表的字节数</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	stroff;		<span class="comment">// 字符串表起始位置的偏移量</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	strsize;	<span class="comment">// 字符串表的字节数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>关于符号表和字符串表段，我们后面再详细介绍。</p>
<p><strong>4.LC_DYSYMTAB</strong></p>
<p>此命令用来加载动态库的符号表，对应的是Dynamic Symbol Table段的数据，此命令的值结构较复杂，定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dysymtab_command</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> cmd;	<span class="comment">/* LC_DYSYMTAB */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> cmdsize;	<span class="comment">/* sizeof(struct dysymtab_command) */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 本地符号，用来调试</span></span><br><span class="line">    <span class="keyword">uint32_t</span> ilocalsym;	<span class="comment">// 本地符号的位置</span></span><br><span class="line">    <span class="keyword">uint32_t</span> nlocalsym;	<span class="comment">// 本地符号的字节数</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 定义的外部符号</span></span><br><span class="line">    <span class="keyword">uint32_t</span> iextdefsym; <span class="comment">// 定义的外部符号位置</span></span><br><span class="line">    <span class="keyword">uint32_t</span> nextdefsym; <span class="comment">// 定义的外部符号字节数</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 未定义的符号</span></span><br><span class="line">    <span class="keyword">uint32_t</span> iundefsym;	<span class="comment">// 未定义的符号位置</span></span><br><span class="line">    <span class="keyword">uint32_t</span> nundefsym;	<span class="comment">// 未定义的符号字节数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 动态绑定相关</span></span><br><span class="line">    <span class="keyword">uint32_t</span> tocoff;	<span class="comment">/* file offset to table of contents */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> ntoc;	<span class="comment">/* number of entries in table of contents */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> modtaboff;	<span class="comment">/* file offset to module table */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> nmodtab;	<span class="comment">/* number of module table entries */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> extrefsymoff;	<span class="comment">/* offset to referenced symbol table */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> nextrefsyms;	<span class="comment">/* number of referenced symbol table entries */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 间接符号表</span></span><br><span class="line">    <span class="keyword">uint32_t</span> indirectsymoff; <span class="comment">/* file offset to the indirect symbol table */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> nindirectsyms;  <span class="comment">/* number of indirect symbol table entries */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重定位相关</span></span><br><span class="line">    <span class="keyword">uint32_t</span> extreloff;	<span class="comment">/* offset to external relocation entries */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> nextrel;	<span class="comment">/* number of external relocation entries */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 本地条目相关</span></span><br><span class="line">    <span class="keyword">uint32_t</span> locreloff;	<span class="comment">/* offset to local relocation entries */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> nlocrel;	<span class="comment">/* number of local relocation entries */</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>5.LC_LOAD_DYLINKER</strong></p>
<p>此命令告知内核需要调用的动态链接器的位置，值结构定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dylinker_command</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	cmd;		<span class="comment">/* LC_ID_DYLINKER, LC_LOAD_DYLINKER or</span></span><br><span class="line"><span class="comment">					   LC_DYLD_ENVIRONMENT */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	cmdsize;	<span class="comment">/* includes pathname string */</span></span><br><span class="line">	<span class="keyword">union</span> lc_str    name;	<span class="comment">// 包含链接器的路径名称字符串起始位置的偏移，真正的动态链接器一般为/usr/lib/dyld</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>6.LC_UUID</strong></p>
<p>此命令加载时可以读取到一个128位的UUID值，结构如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uuid_command</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span>	cmd;		<span class="comment">/* LC_UUID */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>	cmdsize;	<span class="comment">/* sizeof(struct uuid_command) */</span></span><br><span class="line">    <span class="keyword">uint8_t</span>	uuid[<span class="number">16</span>];	<span class="comment">/* the 128-bit uuid */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>7.LC_LOAD_DYLIB</strong></p>
<p>此命令用来加载额外的动态库，这也是一个非常重要的命令，最简单的iOS应用也离不开动态库的使用，通过真实的Mach-O文件我们也可以看到，通常会有多条LC_LOAD_DYLIB命令，每条命令指定一个要加载的动态库。此命令的值结构定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dylib_command</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	cmd;		<span class="comment">/* LC_ID_DYLIB, LC_LOAD_&#123;,WEAK_&#125;DYLIB,</span></span><br><span class="line"><span class="comment">					   LC_REEXPORT_DYLIB */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	cmdsize;	<span class="comment">/* includes pathname string */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dylib</span>	<span class="title">dylib</span>;</span> <span class="comment">// 动态库结构体</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dylib</span> &#123;</span></span><br><span class="line">    <span class="keyword">union</span> lc_str  name;			<span class="comment">// 动态库所在路径字符串的起始位置（相对与当前命令起始的偏移字节）</span></span><br><span class="line">    <span class="keyword">uint32_t</span> timestamp;			<span class="comment">// 库编译时的时间戳</span></span><br><span class="line">    <span class="keyword">uint32_t</span> current_version;   <span class="comment">// 动态库版本号</span></span><br><span class="line">    <span class="keyword">uint32_t</span> compatibility_version;	<span class="comment">// 兼容版本号</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>以UIKit为例，一般的iOS应用都会使用到这个动态库，此命令如下：</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-a696c92899d5aba73e24eb3ee5253fab3b6.png" alt></p>
<p><strong>8.LC_RPATH</strong></p>
<p>此命令用来进行@rpath外部路径变量的映射，我们知道，除了系统本身提供了一些动态共享库外，我们也可以使用外部自定义的动态库，这类外部动态库在加载的时候也需要一个明确的路径，通常在加载外部动态库的命令中，库的路径是以@rpath开头的，Xcode的编译选项中可以自定义设置外部库的寻找路径，同时使用此命令进行解析。此命令的值结构如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rpath_command</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span>	 cmd;		<span class="comment">/* LC_RPATH */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>	 cmdsize;	<span class="comment">/* includes string */</span></span><br><span class="line">    <span class="keyword">union</span> lc_str path;		</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>关于动态库这部分的内容，可以参考之前的一篇文章，其中有更详细的介绍。</p>
<p><a href="https://my.oschina.net/u/2340880/blog/5323143" target="_blank" rel="noopener">https://my.oschina.net/u/2340880/blog/5323143</a></p>
<p><strong>9.LC_FUNCTION_STARTS</strong></p>
<p>此命令的结构与LC_CODE_SIGNATURE一致，用来描述函数表段所在的起始位置和字节数。关于函数表，后面会具体介绍。</p>
<h2 id="四-段与分区"><a href="#四-段与分区" class="headerlink" title="四 段与分区"></a>四 段与分区</h2><p>前面，我们将常见的加载命令进行了介绍，也有提到LS_SEGMENT是非常重要的一个命令，其指导着内核如果将Mach-O文件中的各个段数据加载到内存里。此命令的结构中有一个名为segname的字段，其表示要加载的段的名字，常用宏定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	SEG_PAGEZERO	<span class="meta-string">"__PAGEZERO"</span>  <span class="comment">// 空指针异常捕获段</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	SEG_TEXT	<span class="meta-string">"__TEXT"</span>	<span class="comment">// 代码段</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	SEG_DATA	<span class="meta-string">"__DATA"</span>	<span class="comment">// 数据段</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	SEG_OBJC	<span class="meta-string">"__OBJC"</span>	<span class="comment">// OC运行时段</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	SEG_ICON	 <span class="meta-string">"__ICON"</span>	<span class="comment">// ICON段</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	SEG_LINKEDIT	<span class="meta-string">"__LINKEDIT"</span> <span class="comment">// 链接器使用的符号和其他表段	</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEG_UNIXSTACK	<span class="meta-string">"__UNIXSTACK"</span>	<span class="comment">// unix栈段</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEG_IMPORT	<span class="meta-string">"__IMPORT"</span> <span class="comment">// dyld段</span></span></span><br></pre></td></tr></table></figure>
<p>其中，__PAGEZERO段在进入虚拟内存时是不会分配真实的物理地址的，其只是告诉开发者此段虚拟内存不能使用，最大的作用是如果产生了空指针，会访问到此段中的地址，会直接被捕获报错。</p>
<p>__TEXT段为代码段，其中又包含多个区，命令中的nsects字段描述了当前段有多少个区，区的信息也在命令中进行读取，结构如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">section_64</span> &#123;</span> <span class="comment">/* for 64-bit architectures */</span></span><br><span class="line">	<span class="keyword">char</span>		sectname[<span class="number">16</span>];	<span class="comment">// 分区名</span></span><br><span class="line">	<span class="keyword">char</span>		segname[<span class="number">16</span>];	<span class="comment">// 段名</span></span><br><span class="line">	<span class="keyword">uint64_t</span>	addr;		    <span class="comment">// 分区地址</span></span><br><span class="line">	<span class="keyword">uint64_t</span>	size;		    <span class="comment">// 字节数</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	offset;		    <span class="comment">// 分区在文件中的偏移量</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	align;		    <span class="comment">// 对齐方式</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	reloff;		    <span class="comment">// 重定位条目在文件中的偏移量</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	nreloc;		    <span class="comment">// 重定位条目数</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	flags;		    <span class="comment">// 分区标记</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	reserved1;	    <span class="comment">// 预留</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	reserved2;	    <span class="comment">// 预留</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	reserved3;	    <span class="comment">// 预留</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>通过这些信息可以在Mach-O文件中找到具体的分区所在的位置，将其加载进内存。</p>
<p><strong>__TEXT段下，常见的区列举如下：</strong></p>
<p>__text：主程序代码区</p>
<p>__stubs：动态链接桩区</p>
<p>__objc_methname：Objective-C方法名区</p>
<p>__objc_classname：Objective-C类名区</p>
<p>__objc_methtype：Objective-C方法类型区</p>
<p>__cstring：硬编码的C语言字符串区</p>
<p>__entitlements：配置文件区</p>
<p><strong>__DATA_CONST段下，常见的分区列举如下：</strong></p>
<p>__got：Non-Lazy Symbol Pointers区</p>
<p>__cfstring：程序中使用的CFStringRef区</p>
<p>__objc_classlist：Objective-C类列表区</p>
<p>__objc_protolist：Objective-C原型列表区</p>
<p>__objc_imginfo：Objective-C镜像信息区</p>
<p><strong>__DATA段下，常见的分区列举如下：</strong></p>
<p>__objc_const：Objective-C常量区</p>
<p>__objc_selrefs：Objective-C自引用区</p>
<p>__objc_classrefs：Objective-C类引用区</p>
<p>__objc_supperrefs：Objective-C超类引用区</p>
<h2 id="五-Mach-O的”加载“到底加载的是什么"><a href="#五-Mach-O的”加载“到底加载的是什么" class="headerlink" title="五 Mach-O的”加载“到底加载的是什么"></a>五 Mach-O的”加载“到底加载的是什么</h2><p>现在，我们对Mach-O文件的整体架构已经有了清晰的了解，如果将一个Mach-O文件比作一个完成的工程产品，则文件头好比是此产品的信息表，记录了产品的一些基础信息。加载命令则是产品的组装说明书，用来具体指导此工程产品的组装，之后的内容就是一个个独立的工程组件，我们只需要按照说明书的描述进行组装即可。下面我们对几个核心的区进行介绍。</p>
<h3 id="1-代码段代码区"><a href="#1-代码段代码区" class="headerlink" title="1.代码段代码区"></a>1.代码段代码区</h3><p>首先，对于一个iOS应用的Mach-O文件来说，__TEXT段__text分区是必不可少的，其便是程序的核心代码区，通过可视化的工具可以看到，其中数据就是汇编指令，如下：</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-687282de9602f3fd7441aa201f99b70fef0.png" alt></p>
<h3 id="2-代码段动态链接桩区"><a href="#2-代码段动态链接桩区" class="headerlink" title="2.代码段动态链接桩区"></a>2.代码段动态链接桩区</h3><p>__TEXT段__text区中的代码在调用的动态链接函数需要进行绑定，__TEXT段的__stubs区便是留的动态链接的桩，其具体的解析在Dynamic Symbol Table动态符号表段中。举个例子，__stubs区的符号解析结果如下：</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-f2d4cfe98540d37b2258cb04b18a626403a.png" alt></p>
<p>可以看到，可视化工具中，这些桩已经被解析成了具体的符号，那么是如何解析的呢。其实也很简单，首先每6个字节对应一个符号，之所以是6个字节，是LC_SEGMENT命令中的Size of Stubs字段约定的，如下：</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-a6afc644d7bb14de2977c310e6c3102a934.png" alt></p>
<p>具体的符号定义在Dynamic Symbol Table里面，从前往后与__stubs中的桩一一对应，可以观察下Dynamic Symbol Table表中的数据，如下：</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-5d51006926e7e1dca36612ba542336ab2a7.png" alt></p>
<p>可视化工具已经帮我们将符号进行了解析，实际上动态符号表中存放的只是符号所在位置的下标，并非是符号本身，所有符号都记录在Symbol Table中，以动态符号表中的第一个符号为例，其存储的值为0xB7，转成10进制为183，表示符号表中的第183个符号，找到Symbol Table中下标为183的符号，如下：</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-ebcb7159de6074441e8a098cb4ebff51c02.png" alt></p>
<p>事实上，Symbol Table中记录的是一种标准化的符号结构，其并不会存具体的符号字符串，所有字符串都存在字符串表中，以便节省内存。可以看到，Symbol Table中第183个符号记录其在字符串表中的位置为0xCE，我们在找到String Table，其起始位置为0xD0A0，加上这里的偏移量0xCE为0xD16E，说明要解析的符号存放在0xD16E的位置，String Table中记录的符号是以0x00为分割的，此处的后一个符号刚好就是_NSStringFromClass，如下：</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-b0466c393c91213e425830a30457868ef30.png" alt></p>
<p>到此，动态链接桩被解析完成。其实除了__TEXT段的__stubs区，__DATA_CONST段的__got区也是通过类似的方式来绑定符号的，只是__got区的符号需要链接时绑定，而__stubs区的符号允许运行时绑定，这里后面就不再赘述。</p>
<p>现在，让我们总结上符号绑定的完整过程。首先代码区中的符号需要到__stubs区或__got区进行绑定，__stubs区和__got区对应的加载命令记录了这两个去对应的符号解析的字节数以及在Dynamic Symbol Table表中的起始位置，Dynamic Symbol Table表中记录了当前符号在Symbol Table表中的下标，Symbol表记录了具体的符号实体，其中会包含当前符号在String Table中的位置，符号类型等信息，从String Table中找到具体的符号字符串。</p>
<h3 id="3-Objective-C方法名区，Objective-C类名区，Objective-C方法类型区，C语言字符串区"><a href="#3-Objective-C方法名区，Objective-C类名区，Objective-C方法类型区，C语言字符串区" class="headerlink" title="3.Objective-C方法名区，Objective-C类名区，Objective-C方法类型区，C语言字符串区"></a>3.Objective-C方法名区，Objective-C类名区，Objective-C方法类型区，C语言字符串区</h3><p>__TEXT段的的__objc_methname区顾名思义，记录了应用中所有的Objective-C方法名，直接以字符串的方式存储。</p>
<p>__TEXT段的的__objc_classname区顾名思义，记录了应用中(非动态库)所有的Objective-C类名，直接以字符串的方式存储。</p>
<p>__TEXT段的的__objc_methtype区顾名思义，记录了应用中所有的Objective-C方法的类型，直接以字符串的方式存储。</p>
<p>__TEXT段的的__cstring区顾名思义，记录了应用中所有的C语言字符串，直接以字符串的方式存储。</p>
<h2 id="六-通过otool工具解析Mach-O"><a href="#六-通过otool工具解析Mach-O" class="headerlink" title="六 通过otool工具解析Mach-O"></a>六 通过otool工具解析Mach-O</h2><p>整体看来，Mach-O文件的结构还是比较复杂的，如果没有可视化的工具，要解析此文件还是有些困难。除了MachOView工具外，我们还可以使用原生的otool命令来获取Mach-O文件中的而一些内容。文章的最后，我们来介绍几个常用的命令。</p>
<h3 id="1-查看Mach-O文件头"><a href="#1-查看Mach-O文件头" class="headerlink" title="1.查看Mach-O文件头"></a>1.查看Mach-O文件头</h3><p>命令：otool -h MachOTest.app/MachOTest 或 otool -hV MachOTest.app/MachOTest</p>
<p>hV参数的命令会自动进行可视化。</p>
<p>示例结果：</p>
<p><img src="https://oscimg.oschina.net/oscnet/up-a99ff8d4ac2ecdff7b88f8e08e075bba471.png" alt></p>
<h3 id="2-查看Mach-O的加载命令"><a href="#2-查看Mach-O的加载命令" class="headerlink" title="2.查看Mach-O的加载命令"></a>2.查看Mach-O的加载命令</h3><p>命令：otool -lV MachOTest.app/MachOTest</p>
<p>示例结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br></pre></td><td class="code"><pre><span class="line">MachOTest.app/MachOTest:</span><br><span class="line">Load command 0</span><br><span class="line">      cmd LC_SEGMENT_64</span><br><span class="line">  cmdsize 72</span><br><span class="line">  segname __PAGEZERO</span><br><span class="line">   vmaddr 0x0000000000000000</span><br><span class="line">   vmsize 0x0000000100000000</span><br><span class="line">  fileoff 0</span><br><span class="line"> filesize 0</span><br><span class="line">  maxprot ---</span><br><span class="line"> initprot ---</span><br><span class="line">   nsects 0</span><br><span class="line">    flags (none)</span><br><span class="line">Load command 1</span><br><span class="line">      cmd LC_SEGMENT_64</span><br><span class="line">  cmdsize 712</span><br><span class="line">  segname __TEXT</span><br><span class="line">   vmaddr 0x0000000100000000</span><br><span class="line">   vmsize 0x0000000000004000</span><br><span class="line">  fileoff 0</span><br><span class="line"> filesize 16384</span><br><span class="line">  maxprot r-x</span><br><span class="line"> initprot r-x</span><br><span class="line">   nsects 8</span><br><span class="line">    flags (none)</span><br><span class="line">Section</span><br><span class="line">  sectname __text</span><br><span class="line">   segname __TEXT</span><br><span class="line">      addr 0x0000000100001fb0</span><br><span class="line">      size 0x000000000000051d</span><br><span class="line">    offset 8112</span><br><span class="line">     align 2^4 (16)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_REGULAR</span><br><span class="line">attributes PURE_INSTRUCTIONS SOME_INSTRUCTIONS</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __stubs</span><br><span class="line">   segname __TEXT</span><br><span class="line">      addr 0x00000001000024ce</span><br><span class="line">      size 0x000000000000003c</span><br><span class="line">    offset 9422</span><br><span class="line">     align 2^1 (2)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_SYMBOL_STUBS</span><br><span class="line">attributes PURE_INSTRUCTIONS SOME_INSTRUCTIONS</span><br><span class="line"> reserved1 0 (index into indirect symbol table)</span><br><span class="line"> reserved2 6 (size of stubs)</span><br><span class="line">Section</span><br><span class="line">  sectname __objc_methname</span><br><span class="line">   segname __TEXT</span><br><span class="line">      addr 0x000000010000250a</span><br><span class="line">      size 0x0000000000000dec</span><br><span class="line">    offset 9482</span><br><span class="line">     align 2^0 (1)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_CSTRING_LITERALS</span><br><span class="line">attributes (none)</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __objc_classname</span><br><span class="line">   segname __TEXT</span><br><span class="line">      addr 0x00000001000032f6</span><br><span class="line">      size 0x0000000000000070</span><br><span class="line">    offset 13046</span><br><span class="line">     align 2^0 (1)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_CSTRING_LITERALS</span><br><span class="line">attributes (none)</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __objc_methtype</span><br><span class="line">   segname __TEXT</span><br><span class="line">      addr 0x0000000100003366</span><br><span class="line">      size 0x0000000000000b29</span><br><span class="line">    offset 13158</span><br><span class="line">     align 2^0 (1)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_CSTRING_LITERALS</span><br><span class="line">attributes (none)</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __cstring</span><br><span class="line">   segname __TEXT</span><br><span class="line">      addr 0x0000000100003e8f</span><br><span class="line">      size 0x0000000000000016</span><br><span class="line">    offset 16015</span><br><span class="line">     align 2^0 (1)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_CSTRING_LITERALS</span><br><span class="line">attributes (none)</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __entitlements</span><br><span class="line">   segname __TEXT</span><br><span class="line">      addr 0x0000000100003ea5</span><br><span class="line">      size 0x000000000000010e</span><br><span class="line">    offset 16037</span><br><span class="line">     align 2^0 (1)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_REGULAR</span><br><span class="line">attributes (none)</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __unwind_info</span><br><span class="line">   segname __TEXT</span><br><span class="line">      addr 0x0000000100003fb4</span><br><span class="line">      size 0x0000000000000048</span><br><span class="line">    offset 16308</span><br><span class="line">     align 2^2 (4)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_REGULAR</span><br><span class="line">attributes (none)</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Load command 2</span><br><span class="line">      cmd LC_SEGMENT_64</span><br><span class="line">  cmdsize 472</span><br><span class="line">  segname __DATA_CONST</span><br><span class="line">   vmaddr 0x0000000100004000</span><br><span class="line">   vmsize 0x0000000000004000</span><br><span class="line">  fileoff 16384</span><br><span class="line"> filesize 16384</span><br><span class="line">  maxprot rw-</span><br><span class="line"> initprot rw-</span><br><span class="line">   nsects 5</span><br><span class="line">    flags SG_READ_ONLY</span><br><span class="line">Section</span><br><span class="line">  sectname __got</span><br><span class="line">   segname __DATA_CONST</span><br><span class="line">      addr 0x0000000100004000</span><br><span class="line">      size 0x0000000000000060</span><br><span class="line">    offset 16384</span><br><span class="line">     align 2^3 (8)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_NON_LAZY_SYMBOL_POINTERS</span><br><span class="line">attributes (none)</span><br><span class="line"> reserved1 10 (index into indirect symbol table)</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __cfstring</span><br><span class="line">   segname __DATA_CONST</span><br><span class="line">      addr 0x0000000100004060</span><br><span class="line">      size 0x0000000000000020</span><br><span class="line">    offset 16480</span><br><span class="line">     align 2^3 (8)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_REGULAR</span><br><span class="line">attributes (none)</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __objc_classlist</span><br><span class="line">   segname __DATA_CONST</span><br><span class="line">      addr 0x0000000100004080</span><br><span class="line">      size 0x0000000000000018</span><br><span class="line">    offset 16512</span><br><span class="line">     align 2^3 (8)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_REGULAR</span><br><span class="line">attributes NO_DEAD_STRIP</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __objc_protolist</span><br><span class="line">   segname __DATA_CONST</span><br><span class="line">      addr 0x0000000100004098</span><br><span class="line">      size 0x0000000000000020</span><br><span class="line">    offset 16536</span><br><span class="line">     align 2^3 (8)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_REGULAR</span><br><span class="line">attributes (none)</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __objc_imageinfo</span><br><span class="line">   segname __DATA_CONST</span><br><span class="line">      addr 0x00000001000040b8</span><br><span class="line">      size 0x0000000000000008</span><br><span class="line">    offset 16568</span><br><span class="line">     align 2^2 (4)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_REGULAR</span><br><span class="line">attributes (none)</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Load command 3</span><br><span class="line">      cmd LC_SEGMENT_64</span><br><span class="line">  cmdsize 632</span><br><span class="line">  segname __DATA</span><br><span class="line">   vmaddr 0x0000000100008000</span><br><span class="line">   vmsize 0x0000000000004000</span><br><span class="line">  fileoff 32768</span><br><span class="line"> filesize 16384</span><br><span class="line">  maxprot rw-</span><br><span class="line"> initprot rw-</span><br><span class="line">   nsects 7</span><br><span class="line">    flags (none)</span><br><span class="line">Section</span><br><span class="line">  sectname __objc_const</span><br><span class="line">   segname __DATA</span><br><span class="line">      addr 0x0000000100008000</span><br><span class="line">      size 0x0000000000001368</span><br><span class="line">    offset 32768</span><br><span class="line">     align 2^3 (8)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_REGULAR</span><br><span class="line">attributes (none)</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __objc_selrefs</span><br><span class="line">   segname __DATA</span><br><span class="line">      addr 0x0000000100009368</span><br><span class="line">      size 0x0000000000000018</span><br><span class="line">    offset 37736</span><br><span class="line">     align 2^3 (8)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_LITERAL_POINTERS</span><br><span class="line">attributes NO_DEAD_STRIP</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __objc_classrefs</span><br><span class="line">   segname __DATA</span><br><span class="line">      addr 0x0000000100009380</span><br><span class="line">      size 0x0000000000000010</span><br><span class="line">    offset 37760</span><br><span class="line">     align 2^3 (8)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_REGULAR</span><br><span class="line">attributes NO_DEAD_STRIP</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __objc_superrefs</span><br><span class="line">   segname __DATA</span><br><span class="line">      addr 0x0000000100009390</span><br><span class="line">      size 0x0000000000000008</span><br><span class="line">    offset 37776</span><br><span class="line">     align 2^3 (8)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_REGULAR</span><br><span class="line">attributes NO_DEAD_STRIP</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __objc_ivar</span><br><span class="line">   segname __DATA</span><br><span class="line">      addr 0x0000000100009398</span><br><span class="line">      size 0x0000000000000008</span><br><span class="line">    offset 37784</span><br><span class="line">     align 2^3 (8)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_REGULAR</span><br><span class="line">attributes (none)</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __objc_data</span><br><span class="line">   segname __DATA</span><br><span class="line">      addr 0x00000001000093a0</span><br><span class="line">      size 0x00000000000000f0</span><br><span class="line">    offset 37792</span><br><span class="line">     align 2^3 (8)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_REGULAR</span><br><span class="line">attributes (none)</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Section</span><br><span class="line">  sectname __data</span><br><span class="line">   segname __DATA</span><br><span class="line">      addr 0x0000000100009490</span><br><span class="line">      size 0x0000000000000180</span><br><span class="line">    offset 38032</span><br><span class="line">     align 2^3 (8)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">      type S_REGULAR</span><br><span class="line">attributes (none)</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br><span class="line">Load command 4</span><br><span class="line">      cmd LC_SEGMENT_64</span><br><span class="line">  cmdsize 72</span><br><span class="line">  segname __LINKEDIT</span><br><span class="line">   vmaddr 0x000000010000c000</span><br><span class="line">   vmsize 0x0000000000008000</span><br><span class="line">  fileoff 49152</span><br><span class="line"> filesize 29600</span><br><span class="line">  maxprot r--</span><br><span class="line"> initprot r--</span><br><span class="line">   nsects 0</span><br><span class="line">    flags (none)</span><br><span class="line">Load command 5</span><br><span class="line">      cmd LC_DYLD_CHAINED_FIXUPS</span><br><span class="line">  cmdsize 16</span><br><span class="line">  dataoff 49152</span><br><span class="line"> datasize 680</span><br><span class="line">Load command 6</span><br><span class="line">      cmd LC_DYLD_EXPORTS_TRIE</span><br><span class="line">  cmdsize 16</span><br><span class="line">  dataoff 49832</span><br><span class="line"> datasize 216</span><br><span class="line">Load command 7</span><br><span class="line">     cmd LC_SYMTAB</span><br><span class="line"> cmdsize 24</span><br><span class="line">  symoff 50072</span><br><span class="line">   nsyms 203</span><br><span class="line">  stroff 53408</span><br><span class="line"> strsize 6144</span><br><span class="line">Load command 8</span><br><span class="line">            cmd LC_DYSYMTAB</span><br><span class="line">        cmdsize 80</span><br><span class="line">      ilocalsym 0</span><br><span class="line">      nlocalsym 175</span><br><span class="line">     iextdefsym 175</span><br><span class="line">     nextdefsym 8</span><br><span class="line">      iundefsym 183</span><br><span class="line">      nundefsym 20</span><br><span class="line">         tocoff 0</span><br><span class="line">           ntoc 0</span><br><span class="line">      modtaboff 0</span><br><span class="line">        nmodtab 0</span><br><span class="line">   extrefsymoff 0</span><br><span class="line">    nextrefsyms 0</span><br><span class="line"> indirectsymoff 53320</span><br><span class="line">  nindirectsyms 22</span><br><span class="line">      extreloff 0</span><br><span class="line">        nextrel 0</span><br><span class="line">      locreloff 0</span><br><span class="line">        nlocrel 0</span><br><span class="line">Load command 9</span><br><span class="line">          cmd LC_LOAD_DYLINKER</span><br><span class="line">      cmdsize 32</span><br><span class="line">         name /usr/lib/dyld (offset 12)</span><br><span class="line">Load command 10</span><br><span class="line">     cmd LC_UUID</span><br><span class="line"> cmdsize 24</span><br><span class="line">    uuid 05EC375B-F3C2-3C5A-99D2-28FB938FF144</span><br><span class="line">Load command 11</span><br><span class="line">      cmd LC_BUILD_VERSION</span><br><span class="line">  cmdsize 32</span><br><span class="line"> platform IOSSIMULATOR</span><br><span class="line">    minos 15.5</span><br><span class="line">      sdk 15.5</span><br><span class="line">   ntools 1</span><br><span class="line">     tool LD</span><br><span class="line">  version 764.0</span><br><span class="line">Load command 12</span><br><span class="line">      cmd LC_SOURCE_VERSION</span><br><span class="line">  cmdsize 16</span><br><span class="line">  version 0.0</span><br><span class="line">Load command 13</span><br><span class="line">       cmd LC_MAIN</span><br><span class="line">   cmdsize 24</span><br><span class="line">  entryoff 8672</span><br><span class="line"> stacksize 0</span><br><span class="line">Load command 14</span><br><span class="line">          cmd LC_LOAD_DYLIB</span><br><span class="line">      cmdsize 88</span><br><span class="line">         name /System/Library/Frameworks/Foundation.framework/Foundation (offset 24)</span><br><span class="line">   time stamp 2 Thu Jan  1 08:00:02 1970</span><br><span class="line">      current version 1860.0.0</span><br><span class="line">compatibility version 300.0.0</span><br><span class="line">Load command 15</span><br><span class="line">          cmd LC_LOAD_DYLIB</span><br><span class="line">      cmdsize 56</span><br><span class="line">         name /usr/lib/libobjc.A.dylib (offset 24)</span><br><span class="line">   time stamp 2 Thu Jan  1 08:00:02 1970</span><br><span class="line">      current version 228.0.0</span><br><span class="line">compatibility version 1.0.0</span><br><span class="line">Load command 16</span><br><span class="line">          cmd LC_LOAD_DYLIB</span><br><span class="line">      cmdsize 56</span><br><span class="line">         name /usr/lib/libSystem.B.dylib (offset 24)</span><br><span class="line">   time stamp 2 Thu Jan  1 08:00:02 1970</span><br><span class="line">      current version 1311.120.1</span><br><span class="line">compatibility version 1.0.0</span><br><span class="line">Load command 17</span><br><span class="line">          cmd LC_LOAD_DYLIB</span><br><span class="line">      cmdsize 96</span><br><span class="line">         name /System/Library/Frameworks/CoreFoundation.framework/CoreFoundation (offset 24)</span><br><span class="line">   time stamp 2 Thu Jan  1 08:00:02 1970</span><br><span class="line">      current version 1860.0.0</span><br><span class="line">compatibility version 150.0.0</span><br><span class="line">Load command 18</span><br><span class="line">          cmd LC_LOAD_DYLIB</span><br><span class="line">      cmdsize 80</span><br><span class="line">         name /System/Library/Frameworks/UIKit.framework/UIKit (offset 24)</span><br><span class="line">   time stamp 2 Thu Jan  1 08:00:02 1970</span><br><span class="line">      current version 5610.0.0</span><br><span class="line">compatibility version 1.0.0</span><br><span class="line">Load command 19</span><br><span class="line">          cmd LC_RPATH</span><br><span class="line">      cmdsize 40</span><br><span class="line">         path @executable_path/Frameworks (offset 12)</span><br><span class="line">Load command 20</span><br><span class="line">      cmd LC_FUNCTION_STARTS</span><br><span class="line">  cmdsize 16</span><br><span class="line">  dataoff 50048</span><br><span class="line"> datasize 24</span><br><span class="line">Load command 21</span><br><span class="line">      cmd LC_DATA_IN_CODE</span><br><span class="line">  cmdsize 16</span><br><span class="line">  dataoff 50072</span><br><span class="line"> datasize 0</span><br><span class="line">Load command 22</span><br><span class="line">      cmd LC_CODE_SIGNATURE</span><br><span class="line">  cmdsize 16</span><br><span class="line">  dataoff 59552</span><br><span class="line"> datasize 19200</span><br></pre></td></tr></table></figure>
<h3 id="3-查看依赖的动态库"><a href="#3-查看依赖的动态库" class="headerlink" title="3.查看依赖的动态库"></a>3.查看依赖的动态库</h3><p>命令：otool -L MachOTest.app/MachOTest</p>
<p>示例结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MachOTest.app/MachOTest:</span><br><span class="line">	/System/Library/Frameworks/Foundation.framework/Foundation (compatibility version 300.0.0, current version 1860.0.0)</span><br><span class="line">	/usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 228.0.0)</span><br><span class="line">	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1311.120.1)</span><br><span class="line">	/System/Library/Frameworks/CoreFoundation.framework/CoreFoundation (compatibility version 150.0.0, current version 1860.0.0)</span><br><span class="line">	/System/Library/Frameworks/UIKit.framework/UIKit (compatibility version 1.0.0, current version 5610.0.0)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>专注技术，懂的热爱，愿意分享，做个朋友</p>
<p>QQ：316045346</p>
</blockquote>

    </div>

    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © 微信：15137348047
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/2022/08/17/450iOS分享扩展支持自定义联系人/" class="pre-post btn btn-default" title='iOS分享扩展支持自定义联系人'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">iOS分享扩展支持自定义联系人</span>
        </a>
    
    
        <a href="/2022/08/05/449理解JavaScript中的“面向对象”/" class="next-post btn btn-default" title='理解JavaScript中的“面向对象”'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">理解JavaScript中的“面向对象”</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
<div id="lv-container" data-id="city" data-uid="MTAyMC8zNzY0Ny8xNDE3OA==">
  <script type="text/javascript">
     (function(d, s) {
         var j, e = d.getElementsByTagName(s)[0];
         if (typeof LivereTower === 'function') { return; }
         j = d.createElement(s);
         j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
         j.async = true;
         e.parentNode.insertBefore(j, e);
     })(document, 'script');
  </script>
</div>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#聊聊iOS中的Mach-O"><span class="toc-text">聊聊iOS中的Mach-O</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一-关于Mach-O"><span class="toc-text">一 关于Mach-O</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二-Mach-O头信息"><span class="toc-text">二 Mach-O头信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三-加载命令"><span class="toc-text">三 加载命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四-段与分区"><span class="toc-text">四 段与分区</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五-Mach-O的”加载“到底加载的是什么"><span class="toc-text">五 Mach-O的”加载“到底加载的是什么</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-代码段代码区"><span class="toc-text">1.代码段代码区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-代码段动态链接桩区"><span class="toc-text">2.代码段动态链接桩区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Objective-C方法名区，Objective-C类名区，Objective-C方法类型区，C语言字符串区"><span class="toc-text">3.Objective-C方法名区，Objective-C类名区，Objective-C方法类型区，C语言字符串区</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六-通过otool工具解析Mach-O"><span class="toc-text">六 通过otool工具解析Mach-O</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-查看Mach-O文件头"><span class="toc-text">1.查看Mach-O文件头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-查看Mach-O的加载命令"><span class="toc-text">2.查看Mach-O的加载命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-查看依赖的动态库"><span class="toc-text">3.查看依赖的动态库</span></a></li></ol></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12"> 
                <span>Copyright &copy; 2018
                </span> | 
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> | 
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>



<script src="/js/app.js?rev=@@hash"></script>


</body>
</html>