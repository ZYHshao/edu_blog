<script src="https://eqcn.ajz.miesnfu.com/wp-content/plugins/wp-3d-pony/live2dw/lib/L2Dwidget.min.js"></script> 
<script>
　　let models = [
    "https://unpkg.com/live2d-widget-model-chitose@1.0.5/assets/chitose.model.json",
    "https://unpkg.com/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json",
    "https://unpkg.com/live2d-widget-model-koharu@1.0.5/assets/koharu.model.json",
    "https://unpkg.com/live2d-widget-model-haruto@1.0.5/assets/haruto.model.json",
    "https://unpkg.com/live2d-widget-model-miku@1.0.5/assets/miku.model.json",
    "https://unpkg.com/live2d-widget-model-z16@1.0.5/assets/z16.model.json"
];
let m = models[Math.round(Math.random()*5)];
　　L2Dwidget.init({ 
　　"model": {jsonPath:m,"scale": 1 }, 
　　"display": { "position": "left", "width": 200, "height": 300,"hOffset": 0, "vOffset": -20 }, 
　　"mobile": { "show": true, "scale": 0.5 }, 
　　"react": { "opacityDefault": 0.7, "opacityOnHover": 0.2 } });
</script> 
<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="珲少的技术博客">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://huishao.cc">
    <!--SEO-->

<meta name="description" content="珲少的技术博客">



<meta name="keywords" content="珲少">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">
    <!--Title-->


<title>使用iOS原生sqlite3框架对sqlite数据库进行操作 | 珲少的技术博客</title>


    <link rel="alternate" href="/atom.xml" title="珲少的技术博客" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    





    
</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  style="background-image:url(http://7xpw2b.com1.z0.glb.clouddn.com/hexo-sinppet/img/banner.png)"  >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='珲少'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                <h2> 学如逆水行舟 </h2>
            
    	</div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://huishao.cc">珲少的技术博客</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>主页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/archives/"><i class="fa "></i>归档</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="使用iOS原生sqlite3框架对sqlite数据库进行操作">
            
	            使用iOS原生sqlite3框架对sqlite数据库进行操作
            
        </h1>
        <div class="post-meta">
    
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a href="/categories/iOS逻辑初窥">
            iOS逻辑初窥
        </a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
                
            
        </span>
    </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2016/01/13</span>
        </span>
    
</div>

            
            
    </div>
    
    <div class="post-body post-content">
        <h2 id="使用iOS原生sqlite3框架对sqlite数据库进行操作"><a href="#使用iOS原生sqlite3框架对sqlite数据库进行操作" class="headerlink" title="使用iOS原生sqlite3框架对sqlite数据库进行操作"></a>使用iOS原生sqlite3框架对sqlite数据库进行操作</h2><h3 id="一、引言"><a href="#一、引言" class="headerlink" title="一、引言"></a>一、引言</h3><pre><code>sqlite数据库是一种小型数据库，由于其小巧与简洁，在移动开发领域应用深广，sqlite数据库有一套完备的sqlite语句进行管理操作，一些常用的语句和可视化的开发工具在上篇博客中有介绍，地址如下：
</code></pre><p>sqlite数据库常用语句及可视化工具介绍：<a href="http://my.oschina.net/u/2340880/blog/600820" target="_blank" rel="noopener">http://my.oschina.net/u/2340880/blog/600820</a>。</p>
<pre><code>在iOS的原生开发框架中可以对sqlite数据库进行很好的支持，这个框架中采用C风格且通过指针移动进行数据的操作，使用起来有些不便，我们可以对一些数据库的常用操作进行一些面向对象的封装。
</code></pre><h3 id="二、libsqlite3系统库中操作数据库的常用方法"><a href="#二、libsqlite3系统库中操作数据库的常用方法" class="headerlink" title="二、libsqlite3系统库中操作数据库的常用方法"></a>二、libsqlite3系统库中操作数据库的常用方法</h3><pre><code>libsqlite3是对sqlite数据库进行操作的系统库，在使用前，我们需要先导入，点击Xcode的Build Phases标签，展开Link Binary With Libraries，点击+号，在弹出的窗口中搜索libsqlite3.0，将其导入进工程，过程如下图：
</code></pre><p><img src="http://static.oschina.net/uploads/space/2016/0113/114916_Z4xS_2340880.png" alt></p>
<p><img src="http://static.oschina.net/uploads/space/2016/0113/114917_VKDz_2340880.png" alt></p>
<p>在需要操作sqlite数据的文件中导入如下头文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;sqlite3.h&gt;</span><br></pre></td></tr></table></figure>
<p>数据库文件的操作是由一个sqlite3类型的指针操作管理的，如下方法进行数据库的打开：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqlite3 *sqlite；</span><br><span class="line">sqlite3_open(dataBaePath, &amp;sqlite)</span><br></pre></td></tr></table></figure>
<p>sqlite3_open方法返回一个int值，实际上，在使用libsqlite3框架中的大多方法时都会返回一个int值，这个int值代表着方法执行的相应结果状态，这些状态再sqlite3.h文件中通过宏来定义，列举如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#define SQLITE_OK           0   //操作成功</span><br><span class="line">/* 以下是错误代码 */</span><br><span class="line">#define SQLITE_ERROR        1   /* SQL数据库错误或者丢失*/</span><br><span class="line">#define SQLITE_INTERNAL     2   /* SQL内部逻辑错误 */</span><br><span class="line">#define SQLITE_PERM         3   /* 没有访问权限 */</span><br><span class="line">#define SQLITE_ABORT        4   /* 回调请求终止 */</span><br><span class="line">#define SQLITE_BUSY         5   /* 数据库文件被锁定 */</span><br><span class="line">#define SQLITE_LOCKED       6   /* 数据库中有表被锁定 */</span><br><span class="line">#define SQLITE_NOMEM        7   /* 分配空间失败 */</span><br><span class="line">#define SQLITE_READONLY     8   /* 企图向只读属性的数据库中做写操作 */</span><br><span class="line">#define SQLITE_INTERRUPT    9   /* 通过sqlite3_interrupt()方法终止操作*/</span><br><span class="line">#define SQLITE_IOERR       10   /* 磁盘发生错误 */</span><br><span class="line">#define SQLITE_CORRUPT     11   /* 数据库磁盘格式不正确 */</span><br><span class="line">#define SQLITE_NOTFOUND    12   /* 调用位置操作码 */</span><br><span class="line">#define SQLITE_FULL        13   /* 由于数据库已满造成的添加数据失败 */</span><br><span class="line">#define SQLITE_CANTOPEN    14   /* 不法打开数据库文件 */</span><br><span class="line">#define SQLITE_PROTOCOL    15   /* 数据库锁协议错误 */</span><br><span class="line">#define SQLITE_EMPTY       16   /* 数据库为空 */</span><br><span class="line">#define SQLITE_SCHEMA      17   /* 数据库模式更改 */</span><br><span class="line">#define SQLITE_TOOBIG      18   /* 字符或者二进制数据超出长度 */</span><br><span class="line">#define SQLITE_CONSTRAINT  19   /* 违反协议终止 */</span><br><span class="line">#define SQLITE_MISMATCH    20   /* 数据类型不匹配 */</span><br><span class="line">#define SQLITE_MISUSE      21   /* 库使用不当 */</span><br><span class="line">#define SQLITE_NOLFS       22   /* 使用不支持的操作系统 */</span><br><span class="line">#define SQLITE_AUTH        23   /* 授权拒绝 */</span><br><span class="line">#define SQLITE_FORMAT      24   /* 辅助数据库格式错误 */</span><br><span class="line">#define SQLITE_RANGE       25   /* sqlite3_bind 第二个参数超出范围 */</span><br><span class="line">#define SQLITE_NOTADB      26   /* 打开不是数据库的文件 */</span><br><span class="line">#define SQLITE_NOTICE      27   /* 来自sqlite3_log()的通知 */</span><br><span class="line">#define SQLITE_WARNING     28   /* 来自sqlite3_log() 的警告*/</span><br><span class="line">#define SQLITE_ROW         100  /* sqlite3_step() 方法准备好了一行数据 */</span><br><span class="line">#define SQLITE_DONE        101  /* sqlite3_step() 已完成执行*/</span><br></pre></td></tr></table></figure>
<p>执行非查询类的语句，例如创建，添加，删除等操作，使用如下方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">char * err;</span><br><span class="line">sqlite3 *sql;</span><br><span class="line">sqlite3_exec(sql, sqlStr, NULL, NULL, &amp;err);</span><br></pre></td></tr></table></figure>
<p>sqlite3_exec方法中第一个参数为成功执行了打开数据库操作的sqlite3指针，第二个参数为要执行的sql语句，最后一个参数为错误信息字符串。</p>
<p>执行查询语句的方法比较复杂，通过如下方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    sqlite3 * sqlite;</span><br><span class="line">    sqlite3_stmt *stmt =nil;</span><br><span class="line">    int code = sqlite3_prepare_v2(sqlite, sqlStr, -1, &amp;stmt, NULL);</span><br><span class="line">     while (sqlite3_step(stmt)==SQLITE_ROW) &#123;</span><br><span class="line">         char * cString =(char*)sqlite3_column_text(stmt, 0);</span><br><span class="line">         NSString * value = [NSString stringWithCString:cString?cString:&quot;NULL&quot; encoding:NSUTF8StringEncoding];</span><br><span class="line">         NSNumber * value = [NSNumber numberWithLongLong:sqlite3_column_int64(stmt, 1)];</span><br><span class="line">        &#125;</span><br><span class="line">         sqlite3_finalize(stmt);</span><br></pre></td></tr></table></figure>
<p>stmt是一个数据位置指针，标记查询到数库的数据位置，sqlite3_prepare_v2()方法进行数据库查询的准备工作，第一个参数为成功打开的数据库指针，第二个参数为要执行的查询语句，第三个参数为sqlite3_stmt指针的地址，这个方法也会返回一个int值，作为标记状态是否成功。</p>
<p>sqlite3_step方法对stmt指针进行移动，会逐行进行移动，这个方法会返回一个int值，如果和SQLITE_ROW宏对应，则表明有此行数据，可以通过while循环来对数据进行读取。</p>
<p>sqlite3_column_XXX()是取行中每一列的数据，根据数据类型的不同，sqlite3_column_XXX()有一系列对应的方法，这个方法中第一个参数是stmt指针，第二个参数为列序号。</p>
<p>sqlite3_finalize()方法对stmt指针进行关闭。</p>
<h3 id="三、面向对象的sqlite数据库操作框架封装"><a href="#三、面向对象的sqlite数据库操作框架封装" class="headerlink" title="三、面向对象的sqlite数据库操作框架封装"></a>三、面向对象的sqlite数据库操作框架封装</h3><pre><code>网上不乏有许多优秀的第三方sqlite数据库使用框架，FFDM就是其中之一，并且apple自带的coreData也十分优秀。这篇博客中所述内容并不全面，代码也并不十分完善健壮，封装出来的代码除了能够完成基本的数据库操作外，更多主要是对设计思路的示例。
</code></pre><h4 id="1-面向对象的sqlite管理类的设计思路"><a href="#1-面向对象的sqlite管理类的设计思路" class="headerlink" title="1.面向对象的sqlite管理类的设计思路"></a>1.面向对象的sqlite管理类的设计思路</h4><pre><code>为了便于使用，在设计时，我们尽量将libsqlite3中的方法不暴漏在使用层，通过面向应用的接口来进行方法的设计，设计思路类图如下：
</code></pre><p><img src="http://static.oschina.net/uploads/space/2016/0113/124507_DQiH_2340880.png" alt></p>
<p>图中，文件管理中心对文件进行存取删改管理，不暴漏在外，数据库管理中心负责对数据库的创建，删除打开等操作，具体的数据操作由数据库操作对象来完成。</p>
<h4 id="2-文件管理中心方法的编写"><a href="#2-文件管理中心方法的编写" class="headerlink" title="2.文件管理中心方法的编写"></a>2.文件管理中心方法的编写</h4><pre><code>文件管理中心主要负责对数据库文件的存取，可以实现如下方法：
</code></pre><p>YHBaseCecheCenter.h</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> *  @brief 获取数据库方法的地址</span><br><span class="line"> *</span><br><span class="line"> *  @return 地址字符串</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">-(NSString *)getDataBaseFilePath;</span><br><span class="line">/**</span><br><span class="line"> *  @brief 获取某个数据库的大小</span><br><span class="line"> *</span><br><span class="line"> *  @param name 数据库名称</span><br><span class="line"> *</span><br><span class="line"> *  @return 文件大小 单位M</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">-(float)getSizeFromDataBaseName:(NSString *)name;</span><br></pre></td></tr></table></figure>
<p>YHBaseCecheCenter.m</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-(NSString *)getDataBaseFilePath&#123;</span><br><span class="line">    return NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES).firstObject;</span><br><span class="line">&#125;</span><br><span class="line">-(float)getSizeFromDataBaseName:(NSString *)name&#123;</span><br><span class="line">    NSString * path = [NSString stringWithFormat:@&quot;/%@/%@&quot;,NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES).firstObject,name];</span><br><span class="line">    return  [self fileSizeAtPath:path]/(1024.0*1024.0);</span><br><span class="line">&#125;</span><br><span class="line">//获取文件大小</span><br><span class="line">- (long long) fileSizeAtPath:(NSString*) filePath&#123;</span><br><span class="line">    NSFileManager* manager = [NSFileManager defaultManager];</span><br><span class="line">    if ([manager fileExistsAtPath:filePath])&#123;</span><br><span class="line">        return [[manager attributesOfItemAtPath:filePath error:nil] fileSize];</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在iOS系统中因为其沙盒结构的限制，数据库必须方法documents目录下才能正常打开使用。</p>
<h4 id="3-数据库管理中心的设计"><a href="#3-数据库管理中心的设计" class="headerlink" title="3.数据库管理中心的设计"></a>3.数据库管理中心的设计</h4><pre><code>数据库管理中心主要负责对数据库的宏观操作，采用类方法的设计模式，如下
</code></pre><p>YHBaseSQLiteManager.h</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> *  @brief 打开一个数据库 如果不存在则会创建</span><br><span class="line"> *</span><br><span class="line"> *  @param name 数据库名称</span><br><span class="line"> *</span><br><span class="line"> *  @return 数据库操作对象 如果创建失败会返回nil</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">+(YHBaseSQLiteContext *)openSQLiteWithName:(NSString *)name;</span><br><span class="line">/**</span><br><span class="line"> *  @brief 获取数据库文件的大小 单位M</span><br><span class="line"> *</span><br><span class="line"> *  @param dataBase 数据库上下文对象</span><br><span class="line"> *</span><br><span class="line"> *  @return 数据库文件大小</span><br><span class="line"> */</span><br><span class="line">+(float)getSizeOfDataBase:(YHBaseSQLiteContext *)dataBase;</span><br><span class="line">/**</span><br><span class="line"> *  @brief 获取数据库文件的大小 单位M</span><br><span class="line"> *</span><br><span class="line"> *  @param dataBaseName 数据库名称</span><br><span class="line"> *</span><br><span class="line"> *  @return 数据库文件大小</span><br><span class="line"> */</span><br><span class="line">+(float)getSizeOfDataBaseName:(NSString *)dataBaseName;</span><br><span class="line">/**</span><br><span class="line"> *  @brief 删除所有数据库</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">+(void)removeDataBase;</span><br></pre></td></tr></table></figure>
<p> YHBaseSQLiteManager.m</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">+(YHBaseSQLiteContext *)openSQLiteWithName:(NSString *)name&#123;</span><br><span class="line">    </span><br><span class="line">    NSString * path =  [[YHBaseCecheCenter sharedTheSingletion]getDataBaseFilePath];</span><br><span class="line">    YHBaseSQLiteContext * context = [[YHBaseSQLiteContext alloc]init];</span><br><span class="line">    context.name = name;</span><br><span class="line">    BOOL success = [context openDataBaeWithName:[NSString stringWithFormat:@&quot;%@/%@&quot;,path,name]];</span><br><span class="line">    if (success) &#123;</span><br><span class="line">        return context;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">+(float)getSizeOfDataBase:(YHBaseSQLiteContext *)dataBase&#123;</span><br><span class="line">    return [[YHBaseCecheCenter sharedTheSingletion]getSizeFromDataBaseName:dataBase.name];</span><br><span class="line">&#125;</span><br><span class="line">+(float)getSizeOfDataBaseName:(NSString *)dataBaseName&#123;</span><br><span class="line">    return [[YHBaseCecheCenter sharedTheSingletion]getSizeFromDataBaseName:dataBaseName];</span><br><span class="line">&#125;</span><br><span class="line">+(void)removeDataBase&#123;</span><br><span class="line">    NSString * path =  [[YHBaseCecheCenter sharedTheSingletion]getDataBaseFilePath];</span><br><span class="line">    return [[YHBaseCecheCenter sharedTheSingletion]removeCacheFromPath:path];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-数据库操作对象"><a href="#4-数据库操作对象" class="headerlink" title="4.数据库操作对象"></a>4.数据库操作对象</h4><pre><code>将操作数据库的核心方法封装在这个类中：
</code></pre><p>YHBaseSQLiteContext.h</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> *操作的数据库名称</span><br><span class="line"> */</span><br><span class="line">@property(nonatomic,strong)NSString * name;</span><br><span class="line">/**</span><br><span class="line"> *内含sqlite3 对象</span><br><span class="line"> */</span><br><span class="line">@property(nonatomic,assign)sqlite3 * sqlite3_db;</span><br><span class="line">/**</span><br><span class="line"> * @brief 打开一个数据库 不存在则创建</span><br><span class="line"> *</span><br><span class="line"> * @param path 数据库路径</span><br><span class="line"> *</span><br><span class="line"> * @return 是否操作成功</span><br><span class="line"> */</span><br><span class="line">-(BOOL)openDataBaeWithName:(NSString *)path;</span><br><span class="line">/**</span><br><span class="line"> *  @brief 再数据库中创建一张表 如果已经存在 会返回错误信息</span><br><span class="line"> *</span><br><span class="line"> *  @param name 表的名称</span><br><span class="line"> *</span><br><span class="line"> *  @prarm dic 表中的键 其中字典中需传入 键名：类型  类型的宏定义在YHBaseSQLTypeHeader.h中</span><br><span class="line"> *</span><br><span class="line"> *  @param callBack 结果回调</span><br><span class="line"> */</span><br><span class="line">-(void)createTableWithName:(NSString *)name</span><br><span class="line">            keysDictionary:(NSDictionary&lt;NSString*,NSString*&gt; *) dic</span><br><span class="line">                  callBack:(void (^)(YHBaseSQLError * error))complete;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> *  @brief 向表中添加一条数据</span><br><span class="line"> *</span><br><span class="line"> *  @param dataDic 添加数据的键值对</span><br><span class="line"> *</span><br><span class="line"> *  @param name 插入表的名称</span><br><span class="line"> *</span><br><span class="line"> *  @complete 回调</span><br><span class="line"> */</span><br><span class="line">-(void)insertData:(NSDictionary&lt;NSString *,id&gt;*)dataDic</span><br><span class="line">        intoTable:(NSString *)name</span><br><span class="line">         callBack:(void (^)(YHBaseSQLError * error))complete;</span><br><span class="line">/**</span><br><span class="line"> *  @brief 向表中添加一个键</span><br><span class="line"> *</span><br><span class="line"> *  @param kName 添加的键</span><br><span class="line"> *</span><br><span class="line"> *  @prarm type 类型</span><br><span class="line"> *</span><br><span class="line"> *  @prarm tableName 表名称</span><br><span class="line"> *</span><br><span class="line"> *  @prarm complete 结果回调</span><br><span class="line"> */</span><br><span class="line">-(void)addKey:(NSString *)kName</span><br><span class="line">      keyType:(NSString *)type</span><br><span class="line">    intoTable:(NSString *)tableName</span><br><span class="line">     callBack:(void(^)(YHBaseSQLError *error))complete;</span><br><span class="line">/**</span><br><span class="line"> *  @brief 修改数据</span><br><span class="line"> *</span><br><span class="line"> *  @param dataDic 新的键值</span><br><span class="line"> *</span><br><span class="line"> *  @param wlStr 条件字符串 一般通过主键找到对应数据修改 可以为nil</span><br><span class="line"> *</span><br><span class="line"> *  @param complete 结果回调</span><br><span class="line"> */</span><br><span class="line">-(void)update:(NSDictionary&lt;NSString*,id&gt; *)dataDic</span><br><span class="line">      inTable:(NSString *)tableName</span><br><span class="line">  whileString:(NSString *)wlStr</span><br><span class="line">     callBack:(void(^)(YHBaseSQLError * error))complete;</span><br><span class="line">/**</span><br><span class="line"> *  @brief 删除数据</span><br><span class="line"> *</span><br><span class="line"> *  @param tableName 表名</span><br><span class="line"> *</span><br><span class="line"> *  @param wlStr 条件字符串 一般通过主键找到对应数据删除 可以为nil 不传这个参数将删除所有数据</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">-(void)deleteDataFromTable:(NSString *)tableName</span><br><span class="line">               whereString:(NSString *)wlStr</span><br><span class="line">                  callBack:(void(^)(YHBaseSQLError * error))complete;</span><br><span class="line">/**</span><br><span class="line"> *  @brief 删除一张表</span><br><span class="line"> *</span><br><span class="line"> *  @param tableName 表名</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">-(void)dropTable:(NSString *)tableName</span><br><span class="line">        callBack:(void(^)(YHBaseSQLError * error))complete;</span><br><span class="line">/**</span><br><span class="line"> *  @brief 查询数据</span><br><span class="line"> *</span><br><span class="line"> *  @param keys 要查询的键值 及其对应的数据类型 可以为nil则查询全部</span><br><span class="line"> *</span><br><span class="line"> *  @param tableName 表名</span><br><span class="line"> *</span><br><span class="line"> *  @param orderKey 进行排序的键值 可以为nil 则不排序</span><br><span class="line"> *</span><br><span class="line"> *  @param type 排序方式 在YHBaseSQLTypeHeader中有宏定义</span><br><span class="line"> *</span><br><span class="line"> *  @param wlstr 查询条件 同于查询单个数据</span><br><span class="line"> *</span><br><span class="line"> *  @param complete dataArray为查询到的数据 其内为字典</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">-(void)selectKeys:(NSArray&lt;NSDictionary *&gt; *)keys</span><br><span class="line">        fromTable:(NSString*)tableName</span><br><span class="line">          orderBy:(NSString *)orderKey</span><br><span class="line">        orderType:(NSString *)type</span><br><span class="line">         whileStr:(NSString *)wlstr</span><br><span class="line">         callBack:(void(^)(NSArray&lt;NSDictionary *&gt; * dataArray,YHBaseSQLError * error))complete;</span><br><span class="line">/**</span><br><span class="line"> *  @brief 关闭数据库上下文操作</span><br><span class="line"> *  调用此方法后 这个context对象将不再有效 如果再需要使用 需要YHBaseSQLiteManager中的类方法再次返回</span><br><span class="line"> */</span><br><span class="line">-(void)closeContext;</span><br></pre></td></tr></table></figure>
<p>YHBaseSQLiteContext.m</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br></pre></td><td class="code"><pre><span class="line">-(BOOL)openDataBaeWithName:(NSString *)path&#123;</span><br><span class="line">    if (sqlite3_open([path UTF8String], &amp;_sqlite3_db)!=SQLITE_OK) &#123;</span><br><span class="line">        sqlite3_close(_sqlite3_db);</span><br><span class="line">        _sqlite3_db=nil;</span><br><span class="line">        return NO;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        return YES;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">-(void)createTableWithName:(NSString *)name keysDictionary:(NSDictionary&lt;NSString *,NSString *&gt; *)dic callBack:(void (^)(YHBaseSQLError *))complete&#123;</span><br><span class="line">    NSMutableString * keys = [[NSMutableString alloc]init];</span><br><span class="line">    for (int i=0; i&lt;dic.allKeys.count; i++) &#123;</span><br><span class="line">        NSString * key = dic.allKeys[i];</span><br><span class="line">        if (i&lt;dic.allKeys.count-1) &#123;</span><br><span class="line">            [keys appendFormat:@&quot;%@ %@,&quot;,key,[dic objectForKey:key]];</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            [keys appendFormat:@&quot;%@ %@&quot;,key,[dic objectForKey:key]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    NSString * sqlStr = [NSString stringWithFormat:@&quot;create table %@(%@)&quot;,name,keys];</span><br><span class="line">    [self runSQL:sqlStr callBack:^(YHBaseSQLError * error) &#123;</span><br><span class="line">        </span><br><span class="line">        if (complete) &#123;</span><br><span class="line">            complete(error);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line">-(void)insertData:(NSDictionary&lt;NSString *,id&gt; *)dataDic intoTable:(NSString *)name callBack:(void (^)(YHBaseSQLError *))complete&#123;</span><br><span class="line">    NSMutableString * keys = [[NSMutableString alloc]init];</span><br><span class="line">    NSMutableString * values = [[NSMutableString alloc]init];</span><br><span class="line">    for (int i=0; i&lt;dataDic.allKeys.count; i++) &#123;</span><br><span class="line">        NSString * key = dataDic.allKeys[i];</span><br><span class="line">        if (i&lt;dataDic.count-1) &#123;</span><br><span class="line">            [keys appendFormat:@&quot;%@,&quot;,key];</span><br><span class="line">            [values appendFormat:@&quot;\&quot;%@\&quot;,&quot;,[dataDic objectForKey:key]];</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            [keys appendFormat:@&quot;%@&quot;,key];</span><br><span class="line">            [values appendFormat:@&quot;\&quot;%@\&quot;&quot;,[dataDic objectForKey:key]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    NSString * sqlStr = [NSString stringWithFormat:@&quot;insert into %@(%@) values(%@)&quot;,name,keys,values];</span><br><span class="line">    [self runSQL:sqlStr callBack:^(YHBaseSQLError *error) &#123;</span><br><span class="line">        </span><br><span class="line">        if (complete) &#123;</span><br><span class="line">            complete(error);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line">-(void)addKey:(NSString *)kName keyType:(NSString *)type intoTable:(NSString *)tableName callBack:(void (^)(YHBaseSQLError *))complete&#123;</span><br><span class="line">    NSString * sqlStr = [NSString stringWithFormat:@&quot;alter table %@ add %@ %@&quot;,tableName,kName,type];</span><br><span class="line">    [self runSQL:sqlStr callBack:^(YHBaseSQLError *error) &#123;</span><br><span class="line">        if (complete) &#123;</span><br><span class="line">            complete(error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line">-(void)update:(NSDictionary&lt;NSString *,id&gt; *)dataDic inTable:(NSString *)tableName whileString:(NSString *)wlStr callBack:(void (^)(YHBaseSQLError *))complete&#123;</span><br><span class="line">    NSMutableString * sqlStr = [[NSMutableString alloc]init];</span><br><span class="line">    [sqlStr appendFormat:@&quot;update %@ set &quot;,tableName];</span><br><span class="line">    for (int i=0; i&lt;dataDic.allKeys.count; i++) &#123;</span><br><span class="line">        NSString * key = dataDic.allKeys[i];</span><br><span class="line">        if (i&lt;dataDic.allKeys.count-1) &#123;</span><br><span class="line">            [sqlStr appendFormat:@&quot;%@=\&quot;%@\&quot;,&quot;,key,[dataDic objectForKey:key]];</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            [sqlStr appendFormat:@&quot;%@=\&quot;%@\&quot;&quot;,key,[dataDic objectForKey:key]];</span><br><span class="line">            if (wlStr!=nil) &#123;</span><br><span class="line">                [sqlStr appendFormat:@&quot; where %@&quot;,wlStr];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    [self runSQL:sqlStr callBack:^(YHBaseSQLError *error) &#123;</span><br><span class="line">        if (complete) &#123;</span><br><span class="line">            complete(error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-(void)deleteDataFromTable:(NSString *)tableName whereString:(NSString *)wlStr callBack:(void (^)(YHBaseSQLError *))complete&#123;</span><br><span class="line">    NSMutableString * sqlStr = [[NSMutableString alloc]init];</span><br><span class="line">    [sqlStr appendFormat:@&quot;delete from %@&quot;,tableName];</span><br><span class="line">    if (wlStr!=nil) &#123;</span><br><span class="line">        [sqlStr appendFormat:@&quot; where %@&quot;,wlStr];</span><br><span class="line">    &#125;</span><br><span class="line">    [self runSQL:sqlStr callBack:^(YHBaseSQLError *error) &#123;</span><br><span class="line">        if (complete) &#123;</span><br><span class="line">            complete(error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line">-(void)dropTable:(NSString *)tableName callBack:(void (^)(YHBaseSQLError *))complete&#123;</span><br><span class="line">    NSString * sqlStr = [NSString stringWithFormat:@&quot;drop table %@&quot;,tableName];</span><br><span class="line">    [self runSQL:sqlStr callBack:^(YHBaseSQLError *error) &#123;</span><br><span class="line">        if (complete) &#123;</span><br><span class="line">            complete(error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line">-(void)selectKeys:(NSArray&lt;NSDictionary *&gt; *)keys fromTable:(NSString *)tableName orderBy:(NSString *)orderKey orderType:(NSString *)type whileStr:(NSString *)wlstr callBack:(void (^)(NSArray&lt;NSDictionary *&gt; *, YHBaseSQLError *))complete&#123;</span><br><span class="line">    NSMutableString * sqlStr = [[NSMutableString alloc]init];</span><br><span class="line">    [sqlStr appendFormat:@&quot;select&quot;];</span><br><span class="line">    if (keys==nil||keys.count==0) &#123;</span><br><span class="line">        [sqlStr appendFormat:@&quot; * from %@&quot;,tableName];</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        for (int i=0; i&lt;keys.count; i++) &#123;</span><br><span class="line">            if (i&lt;keys.count-1) &#123;</span><br><span class="line">                [sqlStr appendFormat:@&quot; %@,&quot;,keys[i].allKeys.firstObject];</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                [sqlStr appendFormat:@&quot; %@ from %@&quot;,keys[i].allKeys.firstObject,tableName];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (wlstr) &#123;</span><br><span class="line">        [sqlStr appendFormat:@&quot; where %@&quot;,wlstr];</span><br><span class="line">    &#125;</span><br><span class="line">    if (orderKey) &#123;</span><br><span class="line">        [sqlStr appendFormat:@&quot; order by %@&quot;,orderKey];</span><br><span class="line">    &#125;</span><br><span class="line">    if (type) &#123;</span><br><span class="line">        [sqlStr appendFormat:@&quot; %@&quot;,type];</span><br><span class="line">    &#125;</span><br><span class="line">    NSMutableArray * keysArr = [[NSMutableArray alloc]init];</span><br><span class="line">    NSMutableArray * keysTypeArr = [[NSMutableArray alloc]init];</span><br><span class="line">    if (keys==nil||keys.count==0) &#123;</span><br><span class="line">        NSArray&lt;NSDictionary *&gt; * tmpArr = [self getTheTableAllKeys:tableName];</span><br><span class="line">        for (int i=0; i&lt;tmpArr.count; i++) &#123;</span><br><span class="line">            NSString * key = tmpArr[i].allKeys.firstObject;</span><br><span class="line">            [keysArr addObject:key];</span><br><span class="line">            [keysTypeArr addObject:[tmpArr[i] objectForKey:key]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        for (int i=0; i&lt;keys.count; i++) &#123;</span><br><span class="line">            NSString * key = keys[i].allKeys.firstObject;</span><br><span class="line">            [keysArr addObject:key];</span><br><span class="line">            [keysTypeArr addObject:[keys[i] objectForKey:key]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [self runSelectSQL:sqlStr withKeys:keysArr withDataType:keysTypeArr callBack:^(NSArray&lt;NSDictionary *&gt; *dataArray, YHBaseSQLError *error) &#123;</span><br><span class="line">        if (complete) &#123;</span><br><span class="line">            complete(dataArray,error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line">-(void)closeContext&#123;</span><br><span class="line">    sqlite3_close(_sqlite3_db);</span><br><span class="line">    _sqlite3_db = nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//内部方法 运行创建独立的非查询SQL语句</span><br><span class="line">-(void)runSQL:(NSString *)sql callBack:(void(^)(YHBaseSQLError * error))complete&#123;</span><br><span class="line">    char * err;</span><br><span class="line">    int code = sqlite3_exec(_sqlite3_db, [sql UTF8String], NULL, NULL, &amp;err);</span><br><span class="line">    if (code!=SQLITE_OK) &#123;</span><br><span class="line">        YHBaseSQLError * error = [[YHBaseSQLError alloc]init];</span><br><span class="line">        error.errorInfo = [NSString stringWithCString:err encoding:NSUTF8StringEncoding];</span><br><span class="line">        error.errorCode = code;</span><br><span class="line">        complete(error);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        complete(nil);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//运行查询语句</span><br><span class="line">-(void)runSelectSQL:(NSString *)sql withKeys:(NSArray *)keys withDataType:(NSArray *)dataType callBack:(void(^)(NSArray&lt;NSDictionary *&gt; * dataArray, YHBaseSQLError * error))complete&#123;</span><br><span class="line">    sqlite3_stmt *stmt =nil;</span><br><span class="line">    int code = sqlite3_prepare_v2(_sqlite3_db, [sql UTF8String], -1, &amp;stmt, NULL);</span><br><span class="line">    if (code!=SQLITE_OK) &#123;</span><br><span class="line">        YHBaseSQLError * error = [[YHBaseSQLError alloc]init];</span><br><span class="line">        error.errorInfo = @&quot;查询失败&quot;;</span><br><span class="line">        error.errorCode=code;</span><br><span class="line">        complete(nil,error);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        NSMutableArray * resultArray = [[NSMutableArray alloc]init];</span><br><span class="line">        </span><br><span class="line">        while (sqlite3_step(stmt)==SQLITE_ROW) &#123;</span><br><span class="line">            //数据类型的分别解析</span><br><span class="line">            NSMutableDictionary * dic = [[NSMutableDictionary alloc]init];</span><br><span class="line">            for (int i=0; i&lt;dataType.count; i++) &#123;</span><br><span class="line">                NSString * type = dataType[i];</span><br><span class="line">                if ([type isEqualToString:YHBASE_SQL_DATATYPE_BINARY]) &#123;</span><br><span class="line">                    int length = sqlite3_column_bytes(stmt, i);</span><br><span class="line">                    const void *data = sqlite3_column_blob(stmt, i);</span><br><span class="line">                    NSData * value = [NSData dataWithBytes:data length:length];</span><br><span class="line">                    [dic  setObject:value forKey:keys[i]];</span><br><span class="line">                &#125;else if([type isEqualToString:YHBASE_SQL_DATATYPE_BLOB])&#123;</span><br><span class="line">                    int length = sqlite3_column_bytes(stmt, i);</span><br><span class="line">                    const void *data = sqlite3_column_blob(stmt, i);</span><br><span class="line">                    NSData * value = [NSData dataWithBytes:data length:length];</span><br><span class="line">                    [dic  setObject:value forKey:keys[i]];</span><br><span class="line">                &#125;else if([type isEqualToString:YHBASE_SQL_DATATYPE_BOOLEAN])&#123;</span><br><span class="line">                    NSNumber * value = [NSNumber numberWithInt:sqlite3_column_int(stmt, i)];</span><br><span class="line">                    [dic setObject:value forKey:keys[i]];</span><br><span class="line">                &#125;else if([type isEqualToString:YHBASE_SQL_DATATYPE_CURRENCY])&#123;</span><br><span class="line">                    NSNumber * value = [NSNumber numberWithLong:sqlite3_column_int64(stmt, i)];</span><br><span class="line">                    [dic setObject:value forKey:keys[i]];</span><br><span class="line">                &#125;else if([type isEqualToString:YHBASE_SQL_DATATYPE_DATE])&#123;</span><br><span class="line">                    char * cString =(char*)sqlite3_column_text(stmt, i);</span><br><span class="line">                    NSString * value = [NSString stringWithCString:cString?cString:&quot;NULL&quot; encoding:NSUTF8StringEncoding];</span><br><span class="line">                    [dic setObject:value forKey:keys[i]];</span><br><span class="line">                &#125;else if([type isEqualToString:YHBASE_SQL_DATATYPE_DOUBLE])&#123;</span><br><span class="line">                    NSNumber * value = [NSNumber numberWithFloat:sqlite3_column_double(stmt, i)];</span><br><span class="line">                    [dic setObject:value forKey:keys[i]];</span><br><span class="line">                &#125;else if([type isEqualToString:YHBASE_SQL_DATATYPE_FLOAT])&#123;</span><br><span class="line">                    NSNumber * value = [NSNumber numberWithFloat:sqlite3_column_double(stmt, i)];</span><br><span class="line">                    [dic setObject:value forKey:keys[i]];</span><br><span class="line">                &#125;else if([type isEqualToString:YHBASE_SQL_DATATYPE_INTRGER])&#123;</span><br><span class="line">                    </span><br><span class="line">                    NSNumber * value = [NSNumber numberWithInt:sqlite3_column_int(stmt, i)];</span><br><span class="line">                    [dic setObject:value forKey:keys[i]];</span><br><span class="line">                &#125;else if([type isEqualToString:YHBASE_SQL_DATATYPE_REAL])&#123;</span><br><span class="line">                    NSNumber * value = [NSNumber numberWithDouble:sqlite3_column_int(stmt, i)];</span><br><span class="line">                    [dic setObject:value forKey:keys[i]];</span><br><span class="line">                &#125;else if([type isEqualToString:YHBASE_SQL_DATATYPE_SMALLINT])&#123;</span><br><span class="line">                    NSNumber * value = [NSNumber numberWithShort:sqlite3_column_int(stmt, i)];</span><br><span class="line">                    [dic setObject:value forKey:keys[i]];</span><br><span class="line">                &#125;else if([type isEqualToString:YHBASE_SQL_DATATYPE_TEXT])&#123;</span><br><span class="line">                    char * cString =(char*)sqlite3_column_text(stmt, i);</span><br><span class="line">                    NSString * value = [NSString stringWithCString:cString?cString:&quot;NULL&quot; encoding:NSUTF8StringEncoding];</span><br><span class="line">                    [dic setObject:value forKey:keys[i]];</span><br><span class="line">                &#125;else if([type isEqualToString:YHBASE_SQL_DATATYPE_TIME])&#123;</span><br><span class="line">                    char * cString =(char*)sqlite3_column_text(stmt, i);</span><br><span class="line">                    NSString * value = [NSString stringWithCString:cString?cString:&quot;NULL&quot; encoding:NSUTF8StringEncoding];</span><br><span class="line">                    [dic setObject:value forKey:keys[i]];</span><br><span class="line">                &#125;else if([type isEqualToString:YHBASE_SQL_DATATYPE_TIMESTAMP])&#123;</span><br><span class="line">                    NSNumber * value = [NSNumber numberWithLongLong:sqlite3_column_int64(stmt, i)];</span><br><span class="line">                    [dic setObject:value forKey:keys[i]];</span><br><span class="line">                &#125;else if([type isEqualToString:YHBASE_SQL_DATATYPE_VARCHAR])&#123;</span><br><span class="line">                    char * cString =(char*)sqlite3_column_text(stmt, i);</span><br><span class="line">                    NSString * value = [NSString stringWithCString:cString?cString:&quot;NULL&quot; encoding:NSUTF8StringEncoding];</span><br><span class="line">                    [dic setObject:value forKey:keys[i]];</span><br><span class="line">                &#125;</span><br><span class="line">               </span><br><span class="line">            &#125;</span><br><span class="line">             [resultArray addObject:dic];</span><br><span class="line">        &#125;</span><br><span class="line">         sqlite3_finalize(stmt);</span><br><span class="line">        stmt=nil;</span><br><span class="line">        complete(resultArray,nil);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//获取表中所有字段名和类型</span><br><span class="line">-(NSArray&lt;NSDictionary *&gt; *)getTheTableAllKeys:(NSString *)tableName&#123;</span><br><span class="line">    NSMutableArray * array = [[NSMutableArray alloc]init];</span><br><span class="line">    NSString * getColumn = [NSString stringWithFormat:@&quot;PRAGMA table_info(%@)&quot;,tableName];</span><br><span class="line">    sqlite3_stmt *statement;</span><br><span class="line">    sqlite3_prepare_v2(_sqlite3_db, [getColumn UTF8String], -1, &amp;statement, nil);</span><br><span class="line">    while (sqlite3_step(statement) == SQLITE_ROW) &#123;</span><br><span class="line">        char *nameData = (char *)sqlite3_column_text(statement, 1);</span><br><span class="line">        NSString *columnName = [[NSString alloc] initWithUTF8String:nameData];</span><br><span class="line">        char *typeData = (char *)sqlite3_column_text(statement, 2);</span><br><span class="line">        NSString *columntype = [NSString stringWithCString:typeData encoding:NSUTF8StringEncoding];</span><br><span class="line">        NSDictionary * dic = @&#123;columnName:columntype&#125;;</span><br><span class="line">        [array addObject:dic];</span><br><span class="line">    &#125;</span><br><span class="line">     sqlite3_finalize(statement);</span><br><span class="line">    statement=nil;</span><br><span class="line">    return array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-错误信息类可以将数据库操作中的异常抛出提示开发者"><a href="#5-错误信息类可以将数据库操作中的异常抛出提示开发者" class="headerlink" title="5.错误信息类可以将数据库操作中的异常抛出提示开发者"></a>5.错误信息类可以将数据库操作中的异常抛出提示开发者</h4><p>YHBaseSQLError.h</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> *异常的提示信息</span><br><span class="line"> */</span><br><span class="line">__PROPERTY_NO_STRONG__(NSString *, errorInfo);</span><br><span class="line">/**</span><br><span class="line"> *异常的对应code码</span><br><span class="line"> */</span><br><span class="line">__PROPERTY_NO_ASSIGN__(NSInteger, errorCode);</span><br></pre></td></tr></table></figure>
<p>还有一个头文件中定义了sqlite数据库支持的数据类型和排序宏定义：</p>
<p>YHBaseSQLTypeHeader.h</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#define YHBASE_SQL_DATATYPE_SMALLINT @&quot;smallint&quot; //short</span><br><span class="line">#define YHBASE_SQL_DATATYPE_INTRGER @&quot;integer&quot;    //int</span><br><span class="line">#define YHBASE_SQL_DATATYPE_REAL @&quot;real&quot;          //实数</span><br><span class="line">#define YHBASE_SQL_DATATYPE_FLOAT @&quot;float&quot;        //float</span><br><span class="line">#define YHBASE_SQL_DATATYPE_DOUBLE @&quot;double&quot;      //double</span><br><span class="line">#define YHBASE_SQL_DATATYPE_CURRENCY @&quot;currency&quot;  //long</span><br><span class="line">#define YHBASE_SQL_DATATYPE_VARCHAR @&quot;varchar&quot;    //char</span><br><span class="line">#define YHBASE_SQL_DATATYPE_TEXT @&quot;text&quot;          //string</span><br><span class="line">#define YHBASE_SQL_DATATYPE_BINARY @&quot;binary&quot;      //二进制</span><br><span class="line">#define YHBASE_SQL_DATATYPE_BLOB @&quot;blob&quot;          //长二进制</span><br><span class="line">#define YHBASE_SQL_DATATYPE_BOOLEAN @&quot;boolean&quot;    //bool</span><br><span class="line">#define YHBASE_SQL_DATATYPE_DATE @&quot;date&quot;          //日期</span><br><span class="line">#define YHBASE_SQL_DATATYPE_TIME @&quot;time&quot;          //时间</span><br><span class="line">#define YHBASE_SQL_DATATYPE_TIMESTAMP @&quot;timestamp&quot;//时间戳</span><br><span class="line"></span><br><span class="line">#define YHBASE_SQL_ORDERTYPE_ASC @&quot;asc&quot; //升序</span><br><span class="line">#define YHBASE_SQL_ORDERTYPE_DESC @&quot;desc&quot; //降序</span><br></pre></td></tr></table></figure>
<h3 id="四、使用"><a href="#四、使用" class="headerlink" title="四、使用"></a>四、使用</h3><pre><code>在使用时，直接调用context的相应方法操作数据库即可，例如：
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">YHBaseSQLiteContext * context = [YHBaseSQLiteManager openSQLiteWithName:@&quot;testDataBase&quot;];</span><br><span class="line">    if (context) &#123;</span><br><span class="line">        [context selectKeys:nil fromTable:@&quot;MySQL&quot; orderBy:@&quot;age&quot; orderType:YHBASE_SQL_ORDERTYPE_DESC whileStr:@&quot;age&gt;18&quot; callBack:^(NSArray&lt;NSDictionary *&gt; *dataArray, YHBaseSQLError *error) &#123;</span><br><span class="line">            NSLog(@&quot;%@&quot;,dataArray);</span><br><span class="line">            NSLog(@&quot;%@&quot;,error.errorInfo);</span><br><span class="line">            [context closeContext];</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码将查询textDataBase数据库中MySQL表里所有age列大于18的数据，并按照age从小到大进行排序，数据结果在回调的dataArray中。</p>
<p>外：完整的代码在下面的git地址中，这个git项目是一个基础的开发框架，里面封装了许多开发和调试常用功能，代码不完善之处，希望多多交流，QQ316045346.</p>
<p>git：<a href="https://github.com/ZYHshao/YHBaseFoundationTest" target="_blank" rel="noopener">https://github.com/ZYHshao/YHBaseFoundationTest</a>。</p>
<blockquote>
<p>专注技术，热爱生活，交流技术，也做朋友。</p>
<p>——珲少 QQ群：203317592</p>
</blockquote>

    </div>

    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © 微信：15137348047
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/2016/01/24/170iOS中播放gif动态图的方式探讨/" class="pre-post btn btn-default" title='iOS中播放gif动态图的方式探讨'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">iOS中播放gif动态图的方式探讨</span>
        </a>
    
    
        <a href="/2016/01/11/168SQLite数据库常用语句及MAC上的SQLite可视化工具MeasSQLlite使用/" class="next-post btn btn-default" title='SQLite数据库常用语句及MAC上的SQLite可视化工具MeasSQLlite使用'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">SQLite数据库常用语句及MAC上的SQLite可视化工具MeasSQLlite使用</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
<div id="lv-container" data-id="city" data-uid="MTAyMC8zNzY0Ny8xNDE3OA==">
  <script type="text/javascript">
     (function(d, s) {
         var j, e = d.getElementsByTagName(s)[0];
         if (typeof LivereTower === 'function') { return; }
         j = d.createElement(s);
         j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
         j.async = true;
         e.parentNode.insertBefore(j, e);
     })(document, 'script');
  </script>
</div>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用iOS原生sqlite3框架对sqlite数据库进行操作"><span class="toc-text">使用iOS原生sqlite3框架对sqlite数据库进行操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、引言"><span class="toc-text">一、引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、libsqlite3系统库中操作数据库的常用方法"><span class="toc-text">二、libsqlite3系统库中操作数据库的常用方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三、面向对象的sqlite数据库操作框架封装"><span class="toc-text">三、面向对象的sqlite数据库操作框架封装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-面向对象的sqlite管理类的设计思路"><span class="toc-text">1.面向对象的sqlite管理类的设计思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-文件管理中心方法的编写"><span class="toc-text">2.文件管理中心方法的编写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-数据库管理中心的设计"><span class="toc-text">3.数据库管理中心的设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-数据库操作对象"><span class="toc-text">4.数据库操作对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-错误信息类可以将数据库操作中的异常抛出提示开发者"><span class="toc-text">5.错误信息类可以将数据库操作中的异常抛出提示开发者</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四、使用"><span class="toc-text">四、使用</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12"> 
                <span>Copyright &copy; 2018
                </span> | 
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> | 
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>



<script src="/js/app.js?rev=@@hash"></script>


</body>
</html>